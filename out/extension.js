(()=>{"use strict";var e,t,a,r={167:e=>{e.exports=require("worker_threads")},398:e=>{e.exports=require("vscode")},857:e=>{e.exports=require("os")}},s={};function i(e){var t=s[e];if(void 0!==t)return t.exports;var a=s[e]={exports:{}};return r[e](a,a.exports,i),a.exports}i.m=r,t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,i.t=function(a,r){if(1&r&&(a=this(a)),8&r)return a;if("object"==typeof a&&a){if(4&r&&a.__esModule)return a;if(16&r&&"function"==typeof a.then)return a}var s=Object.create(null);i.r(s);var n={};e=e||[null,t({}),t([]),t(t)];for(var o=2&r&&a;"object"==typeof o&&!~e.indexOf(o);o=t(o))Object.getOwnPropertyNames(o).forEach((e=>n[e]=()=>a[e]));return n.default=()=>a,i.d(s,n),s},i.d=(e,t)=>{for(var a in t)i.o(t,a)&&!i.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce(((t,a)=>(i.f[a](e,t),t)),[])),i.u=e=>e+".extension.js",i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a={792:1},i.f.require=(e,t)=>{a[e]||(e=>{var t=e.modules,r=e.ids,s=e.runtime;for(var n in t)i.o(t,n)&&(i.m[n]=t[n]);s&&s(i);for(var o=0;o<r.length;o++)a[r[o]]=1})(require("./"+i.u(e)))};var n={};i.r(n),i.d(n,{activate:()=>I,deactivate:()=>W});var o=i(398);class c{static initialize(){this.outputChannel=o.window.createOutputChannel("MyBatis ER Generator")}static info(e,...t){const a=`[${(new Date).toISOString()}] INFO: ${e}`;console.log(a,...t),this.outputChannel?.appendLine(a)}static warn(e,...t){const a=`[${(new Date).toISOString()}] WARN: ${e}`;console.warn(a,...t),this.outputChannel?.appendLine(a)}static error(e,t,...a){const r=`[${(new Date).toISOString()}] ERROR: ${e}`,s=t?`\n${t.stack}`:"";console.error(r,t,...a),this.outputChannel?.appendLine(r+s)}static debug(e,...t){const a=`[${(new Date).toISOString()}] DEBUG: ${e}`;console.debug(a,...t),this.outputChannel?.appendLine(a)}static show(){this.outputChannel?.show()}static clear(){this.outputChannel?.clear()}static dispose(){this.outputChannel?.dispose()}}const l=class e{constructor(e){this.context=e,this.workspaceState=e.workspaceState,this.globalState=e.globalState,c.info("状态管理器已初始化")}static initialize(t){return e.instance||(e.instance=new e(t)),e.instance}static getInstance(){if(!e.instance)throw new Error("StateManager未初始化，请先调用initialize()");return e.instance}async saveERDiagramData(t){try{await this.workspaceState.update(e.KEYS.ER_DIAGRAM_DATA,{...t,generatedAt:t.generatedAt.toISOString()}),await this.workspaceState.update(e.KEYS.LAST_SCAN_TIME,Date.now()),c.info(`ER图数据已保存，包含${t.entities.length}个实体，${t.relations.length}个关系`)}catch(e){throw c.error("保存ER图数据失败",e),e}}async getERDiagramData(){try{const t=this.workspaceState.get(e.KEYS.ER_DIAGRAM_DATA);if(!t)return;return{...t,generatedAt:new Date(t.generatedAt)}}catch(e){return void c.error("获取ER图数据失败",e)}}async clearERDiagramData(){try{await this.workspaceState.update(e.KEYS.ER_DIAGRAM_DATA,void 0),await this.workspaceState.update(e.KEYS.LAST_SCAN_TIME,void 0),c.info("ER图数据已清除")}catch(e){throw c.error("清除ER图数据失败",e),e}}async saveProjectConfig(t){try{const a={...await this.getProjectConfig(),...t};await this.workspaceState.update(e.KEYS.PROJECT_CONFIG,a),c.info("项目配置已保存",a)}catch(e){throw c.error("保存项目配置失败",e),e}}async getProjectConfig(){try{return{autoRefresh:!0,includeTestFiles:!1,inferenceStrategies:{naming:!0,xml:!0,annotation:!0,semantic:!0},theme:"auto",exportFormat:"png",execution:{useWorkerThreads:!1,useMainThreadSerial:!0,maxConcurrency:4,batchSize:10,timeout:3e4},...this.workspaceState.get(e.KEYS.PROJECT_CONFIG)}}catch(e){return c.error("获取项目配置失败",e),{autoRefresh:!0,includeTestFiles:!1,inferenceStrategies:{naming:!0,xml:!0,annotation:!0,semantic:!0},theme:"auto",exportFormat:"png",execution:{useWorkerThreads:!1,useMainThreadSerial:!0,maxConcurrency:4,batchSize:10,timeout:3e4}}}}getLastScanTime(){return this.workspaceState.get(e.KEYS.LAST_SCAN_TIME)}isCacheValid(e=3e5){const t=this.getLastScanTime();return!!t&&Date.now()-t<e}async saveEntityCache(t,a){try{const r=this.workspaceState.get(e.KEYS.WORKSPACE_ENTITIES)||{};r[t]={data:a,timestamp:Date.now()},await this.workspaceState.update(e.KEYS.WORKSPACE_ENTITIES,r)}catch(e){c.error("保存实体缓存失败",e)}}getEntityCache(t){try{const a=(this.workspaceState.get(e.KEYS.WORKSPACE_ENTITIES)||{})[t];if(!a)return;if(Date.now()-a.timestamp>3e5)return;return a.data}catch(e){return void c.error("获取实体缓存失败",e)}}async cleanExpiredCache(){try{const t=this.workspaceState.get(e.KEYS.WORKSPACE_ENTITIES)||{},a=Date.now(),r=3e5,s={};let i=0;for(const[e,n]of Object.entries(t))a-n.timestamp<=r?s[e]=n:i++;i>0&&(await this.workspaceState.update(e.KEYS.WORKSPACE_ENTITIES,s),c.info(`清除了${i}个过期缓存项`))}catch(e){c.error("清除过期缓存失败",e)}}getCurrentWorkspacePath(){const e=o.workspace.workspaceFolders;return e?.[0]?.uri.fsPath}async isMyBatisProject(){if(!this.getCurrentWorkspacePath())return!1;try{const e=await o.workspace.findFiles("**/{*.xml,pom.xml,build.gradle,application.yml,application.properties}","**/node_modules/**",10),t=await o.workspace.findFiles(".gitignore");if(t.length>0){const a=await o.workspace.fs.readFile(t[0]),r=Buffer.from(a).toString("utf8").split("\n").map((e=>e.trim())).filter((e=>e&&!e.startsWith("#"))),s=e.filter((e=>{const t=o.workspace.asRelativePath(e);return!r.some((e=>e.includes("*")?new RegExp(e.replace(/\*/g,".*")).test(t):t.includes(e)))}));e.splice(0,e.length,...s)}for(const t of e){const e=await o.workspace.fs.readFile(t),a=Buffer.from(e).toString("utf8");if(a.includes("mybatis")||a.includes("MyBatis")||a.includes("mybatis-plus")||a.includes("com.baomidou"))return!0}return!1}catch(e){return c.error("检查MyBatis项目失败",e),!1}}async saveGlobalSetting(e,t){try{await this.globalState.update(e,t),c.debug(`全局设置已保存: ${e}`)}catch(e){throw c.error("保存全局设置失败",e),e}}getGlobalSetting(e,t){return void 0!==t?this.globalState.get(e,t):this.globalState.get(e)}async resetWorkspaceState(){try{const t=Object.values(e.KEYS);for(const e of t)await this.workspaceState.update(e,void 0);c.info("工作空间状态已重置")}catch(e){throw c.error("重置工作空间状态失败",e),e}}getStateStats(){const t=this.getLastScanTime();return{workspacePath:this.getCurrentWorkspacePath(),lastScanTime:t?new Date(t).toISOString():null,cacheValid:this.isCacheValid(),hasERData:!!this.workspaceState.get(e.KEYS.ER_DIAGRAM_DATA)}}};l.KEYS={ER_DIAGRAM_DATA:"erDiagramData",LAST_SCAN_TIME:"lastScanTime",PROJECT_CONFIG:"projectConfig",CACHE_VERSION:"cacheVersion",WORKSPACE_ENTITIES:"workspaceEntities",INFERENCE_CACHE:"inferenceCache"};let h=l;class m{constructor(){this.configChangeListeners=[],o.workspace.onDidChangeConfiguration(this.onConfigurationChanged.bind(this)),c.info("配置管理器已初始化")}static getInstance(){return m.instance||(m.instance=new m),m.instance}getExtensionConfig(){const e=o.workspace.getConfiguration("mybatis-er");return{autoRefresh:e.get("autoRefresh",!0),includeTestFiles:e.get("includeTestFiles",!1),inferenceStrategies:e.get("inferenceStrategies",{naming:!0,xml:!0,annotation:!0,semantic:!0}),theme:e.get("theme","auto"),exportFormat:e.get("exportFormat","png"),execution:e.get("execution",{useWorkerThreads:!1,useMainThreadSerial:!0,maxConcurrency:2,batchSize:5,timeout:15e3})}}async updateExtensionConfig(e,t,a){try{const r=o.workspace.getConfiguration("mybatis-er");await r.update(e,t,a||o.ConfigurationTarget.Workspace),c.info(`配置已更新: ${e} = ${JSON.stringify(t)}`)}catch(t){throw c.error(`更新配置失败: ${e}`,t),t}}getWorkspaceConfig(){return{javaHome:this.getJavaConfig("home"),javaSourcePaths:this.getJavaConfig("sourcePaths",[]),includePatterns:this.getFileConfig("include",["**/*.java","**/*.xml"]),excludePatterns:this.getFileConfig("exclude",["**/node_modules/**","**/target/**","**/build/**","**/.git/**"]),tabSize:this.getEditorConfig("tabSize",4),insertSpaces:this.getEditorConfig("insertSpaces",!0),searchMaxResults:this.getSearchConfig("maxResults",1e3),searchTimeout:this.getSearchConfig("timeout",1e4)}}getJavaConfig(e,t){return o.workspace.getConfiguration("java").get(e,t)}getFileConfig(e,t){return o.workspace.getConfiguration("files").get(e,t)}getEditorConfig(e,t){return o.workspace.getConfiguration("editor").get(e,t)}getSearchConfig(e,t){return o.workspace.getConfiguration("search").get(e,t)}getMyBatisConfig(){const e=o.workspace.getConfiguration("mybatis-er");return{parseTimeout:e.get("parseTimeout",3e4),maxFileSize:e.get("maxFileSize",10485760),inferenceTimeout:e.get("inferenceTimeout",1e4),minConfidence:e.get("minConfidence",.6),cacheEnabled:e.get("cacheEnabled",!0),cacheMaxAge:e.get("cacheMaxAge",3e5),maxEntitiesInView:e.get("maxEntitiesInView",500),animationEnabled:e.get("animationEnabled",!0),exportPath:e.get("exportPath",""),exportQuality:e.get("exportQuality",1)}}getPerformanceConfig(){const e=o.workspace.getConfiguration("mybatis-er");return{maxWorkers:e.get("maxWorkers",Math.max(2,Math.floor(i(857).cpus().length/2))),workerTimeout:e.get("workerTimeout",3e4),maxMemoryUsage:e.get("maxMemoryUsage",104857600),gcThreshold:e.get("gcThreshold",.8),maxConcurrentParsing:e.get("maxConcurrentParsing",4),batchSize:e.get("batchSize",50),enableProfiling:e.get("enableProfiling",!1),logLevel:e.get("logLevel","info")}}validateConfig(){const e=[],t=this.getExtensionConfig(),a=this.getMyBatisConfig(),r=this.getPerformanceConfig();"boolean"!=typeof t.autoRefresh&&e.push("autoRefresh必须是布尔值"),["auto","light","dark"].includes(t.theme)||e.push("theme必须是auto、light或dark之一"),["png","svg","pdf","mermaid"].includes(t.exportFormat)||e.push("exportFormat必须是png、svg、pdf或mermaid之一");const s=t.inferenceStrategies;if("object"!=typeof s||null===s)e.push("inferenceStrategies必须是对象");else{const t=["naming","xml","annotation","semantic"];for(const a of t)"boolean"!=typeof s[a]&&e.push(`inferenceStrategies.${a}必须是布尔值`)}return(r.maxWorkers<1||r.maxWorkers>16)&&e.push("maxWorkers必须在1-16之间"),(a.minConfidence<0||a.minConfidence>1)&&e.push("minConfidence必须在0-1之间"),{valid:0===e.length,errors:e}}async resetToDefaults(){try{const e=o.workspace.getConfiguration("mybatis-er"),t=["autoRefresh","inferenceStrategies","theme","exportFormat","parseTimeout","maxFileSize","inferenceTimeout","minConfidence","cacheEnabled","cacheMaxAge","maxEntitiesInView","animationEnabled"];for(const a of t)await e.update(a,void 0,o.ConfigurationTarget.Workspace);c.info("配置已重置为默认值")}catch(e){throw c.error("重置配置失败",e),e}}exportConfig(){return{extension:this.getExtensionConfig(),workspace:this.getWorkspaceConfig(),mybatis:this.getMyBatisConfig(),performance:this.getPerformanceConfig(),timestamp:(new Date).toISOString()}}async importConfig(e){try{if(!e.extension)throw new Error("无效的配置数据");const t=e.extension,a=o.workspace.getConfiguration("mybatis-er");for(const[e,r]of Object.entries(t))await a.update(e,r,o.ConfigurationTarget.Workspace);c.info("配置导入成功")}catch(e){throw c.error("导入配置失败",e),e}}onConfigChanged(e){return this.configChangeListeners.push(e),new o.Disposable((()=>{const t=this.configChangeListeners.indexOf(e);t>=0&&this.configChangeListeners.splice(t,1)}))}onConfigurationChanged(e){if(e.affectsConfiguration("mybatis-er")){const e=this.getExtensionConfig();c.info("配置已变更",e),this.configChangeListeners.forEach((t=>{try{t(e)}catch(e){c.error("配置变更监听器执行失败",e)}}))}}getConfigSummary(){const e=this.validateConfig(),t=this.getExtensionConfig(),a=this.getPerformanceConfig();return{valid:e.valid,errors:e.errors,autoRefresh:t.autoRefresh,enabledStrategies:Object.entries(t.inferenceStrategies).filter((([e,t])=>t)).map((([e,t])=>e)),theme:t.theme,maxWorkers:a.maxWorkers,cacheEnabled:this.getMyBatisConfig().cacheEnabled}}}var d=i(167);const u=require("path"),g=require("events");var f=(e=>(e.PARSE_JAVA_FILE="PARSE_JAVA_FILE",e.PARSE_XML_FILE="PARSE_XML_FILE",e.PARSE_BATCH_FILES="PARSE_BATCH_FILES",e.INFER_RELATIONS="INFER_RELATIONS",e.VALIDATE_RELATIONS="VALIDATE_RELATIONS",e.GENERATE_DIAGRAM="GENERATE_DIAGRAM",e.EXPORT_DIAGRAM="EXPORT_DIAGRAM",e.PING="PING",e.PONG="PONG",e.TERMINATE="TERMINATE",e.ERROR="ERROR",e.PROGRESS="PROGRESS",e))(f||{}),p=(e=>(e.IDLE="idle",e.BUSY="busy",e.ERROR="error",e.TERMINATED="terminated",e))(p||{});class w extends g.EventEmitter{constructor(e={}){super(),this.workers=new Map,this.workerInfos=new Map,this.taskQueue=[],this.activeTasks=new Map,this.pendingResponses=new Map,this.isShuttingDown=!1;const t=i(857).cpus().length;this.config={maxWorkers:Math.min(2*t,16),workerTimeout:3e4,maxQueueSize:100,heartbeatInterval:5e3,maxRetries:3,enableProfiling:!1,...e},this.stats={activeWorkers:0,idleWorkers:0,queuedTasks:0,processingTasks:0,totalProcessedTasks:0,averageQueueTime:0,systemLoad:0},this.startHeartbeat(),this.startResourceMonitoring(),c.info("WorkerManager initialized with optimized config",{maxWorkers:this.config.maxWorkers,timeout:this.config.workerTimeout,queueSize:this.config.maxQueueSize})}async start(){if(this.isShuttingDown)throw new Error("WorkerManager is shutting down");try{await this.createWorker(),c.info("WorkerManager started with 1 initial worker")}catch(e){throw c.error("Failed to create initial worker",e),e}}async shutdown(){this.isShuttingDown=!0,this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.resourceMonitorInterval&&clearInterval(this.resourceMonitorInterval),this.taskQueue=[];for(const[e,t]of this.pendingResponses)clearTimeout(t.timeout),t.reject(new Error("WorkerManager is shutting down"));this.pendingResponses.clear();const e=Array.from(this.workers.values()).map((e=>this.terminateWorker(e)));await Promise.all(e),this.workers.clear(),this.workerInfos.clear(),this.activeTasks.clear(),c.info("WorkerManager shutdown completed")}async submitTask(e,t,a={}){if(this.isShuttingDown)throw new Error("WorkerManager is shutting down");if(this.taskQueue.length>=this.config.maxQueueSize)throw new Error("Task queue is full");const r={id:this.generateTaskId(),type:e,data:t,priority:a.priority||5,timeout:a.timeout||this.config.workerTimeout,retryCount:0,maxRetries:a.maxRetries||this.config.maxRetries,createdAt:Date.now()};return new Promise(((e,t)=>{this.addTaskToQueue(r);const a=setTimeout((()=>{this.pendingResponses.delete(r.id),t(new Error(`Task ${r.id} timed out after ${r.timeout}ms`))}),r.timeout);this.pendingResponses.set(r.id,{resolve:e,reject:t,timeout:a}),this.processQueue()}))}async submitBatchTasks(e){if(0===e.length)return[];if(e.length<=10)return Promise.all(e.map((e=>this.submitTask(e.type,e.data,e.options))));const t=[];for(let a=0;a<e.length;a+=5){const r=e.slice(a,a+5),s=await Promise.all(r.map((e=>this.submitTask(e.type,e.data,e.options))));t.push(...s),a+5<e.length&&await new Promise((e=>setTimeout(e,100)))}return t}getStats(){return this.updateStats(),{...this.stats}}getWorkerInfos(){return Array.from(this.workerInfos.values())}getWorkerProcessingDetails(){const e=[];for(const[t,a]of this.workerInfos){const r={workerId:t,status:a.status,processedTasks:a.processedTasks,errorCount:a.errorCount};if(a.currentTaskId){const e=this.activeTasks.get(a.currentTaskId);e&&(r.currentTask={id:e.id,type:e.type,startedAt:e.startedAt||e.createdAt,duration:Date.now()-(e.startedAt||e.createdAt),description:this.getTaskDescription(e)})}e.push(r)}return e}getTaskDescription(e){switch(e.type){case f.PARSE_JAVA_FILE:return`解析Java文件: ${e.data?.filePath||"未知文件"}`;case f.PARSE_XML_FILE:return`解析XML文件: ${e.data?.filePath||"未知文件"}`;case f.PARSE_BATCH_FILES:return`批量解析文件: ${e.data?.files?.length||0}个文件`;case f.INFER_RELATIONS:return`推断关系: ${e.data?.entities?.length||0}个实体`;case f.VALIDATE_RELATIONS:return`验证关系: ${e.data?.relations?.length||0}个关系`;case f.GENERATE_DIAGRAM:return`生成图表: ${e.data?.entities?.length||0}个实体`;case f.EXPORT_DIAGRAM:return`导出图表: ${e.data?.format||"未知格式"}`;default:return`执行任务: ${e.type}`}}logWorkerProcessingStatus(){const e=this.getWorkerProcessingDetails(),t=this.getStats();c.info("=== Worker处理状态报告 ==="),c.info(`总Worker数: ${this.workers.size}/${this.config.maxWorkers}`),c.info(`活跃Worker: ${t.activeWorkers}, 空闲Worker: ${t.idleWorkers}`),c.info(`队列任务: ${t.queuedTasks}, 处理中任务: ${t.processingTasks}`),e.forEach((e=>{if(e.status===p.BUSY&&e.currentTask){const t=e.currentTask,a=Math.round(t.duration/1e3);c.info(`🔄 Worker ${e.workerId}: ${t.description} (${a}秒)`)}else c.info(`💤 Worker ${e.workerId}: ${e.status} (已处理${e.processedTasks}个任务)`)})),c.info("========================")}getHealthStatus(){const e=[],t=[],a=this.getStats();return process.memoryUsage().heapUsed>52428800&&(e.push("内存使用过高"),t.push("考虑清理缓存或减少并发任务")),a.activeWorkers>this.config.maxWorkers&&(e.push("Worker数量超限"),t.push("等待当前任务完成或重启扩展")),a.queuedTasks>.8*this.config.maxQueueSize&&(e.push("任务队列接近满载"),t.push("减少并发操作或增加处理能力")),{healthy:0===e.length,issues:e,recommendations:t}}async createWorker(){const e=this.generateWorkerId(),t=u.join(__dirname,"workers","worker-thread.js");try{const a=new d.Worker(t,{workerData:{workerId:e,config:this.config},env:{...process.env,NODE_ENV:"worker"}});return this.workers.set(e,a),this.workerInfos.set(e,{id:e,status:p.IDLE,processedTasks:0,errorCount:0,createdAt:Date.now(),lastActiveAt:Date.now(),averageProcessingTime:0}),this.setupWorkerListeners(a,e),c.info(`Worker created: ${e}`),e}catch(t){throw c.error(`Failed to create worker: ${e}`,t),this.workerInfos.delete(e),t}}setupWorkerListeners(e,t){e.on("message",(e=>{this.handleWorkerMessage(t,e)})),e.on("error",(e=>{this.handleWorkerError(t,e)})),e.on("exit",(e=>{this.handleWorkerExit(t,e)}))}handleWorkerMessage(e,t){const a=this.workerInfos.get(e);if(a)switch(a.lastActiveAt=Date.now(),t.type){case f.PONG:break;case f.PROGRESS:this.emit("progress",t.payload);break;case f.ERROR:this.handleTaskError(e,t);break;default:t.isResponse&&t.responseToId&&this.handleTaskResponse(e,t)}}handleTaskResponse(e,t){const a=t.responseToId,r=this.pendingResponses.get(a),s=this.activeTasks.get(a),i=this.workerInfos.get(e);if(!r||!s||!i)return;clearTimeout(r.timeout),this.pendingResponses.delete(a),this.activeTasks.delete(a),i.status=p.IDLE,i.currentTaskId=void 0,i.processedTasks++;const n=Date.now()-(s.startedAt||s.createdAt);i.averageProcessingTime=(i.averageProcessingTime*(i.processedTasks-1)+n)/i.processedTasks,s.completedAt=Date.now(),this.stats.totalProcessedTasks++;const o=t.payload;o.success?(r.resolve(o.data),this.emit("taskCompleted",{taskId:a,workerId:e,result:o.data})):(r.reject(new Error(o.error||"Task failed")),this.emit("taskFailed",{taskId:a,workerId:e,error:o.error})),this.processQueue()}handleTaskError(e,t){const a=t.payload,r=this.workerInfos.get(e);if(r&&(r.errorCount++,r.status=p.ERROR),a.taskId){const e=this.pendingResponses.get(a.taskId),t=this.activeTasks.get(a.taskId);e&&t&&(t.retryCount<t.maxRetries?(t.retryCount++,this.addTaskToQueue(t),c.warn(`Retrying task ${t.id}, attempt ${t.retryCount}/${t.maxRetries}`)):(clearTimeout(e.timeout),this.pendingResponses.delete(a.taskId),this.activeTasks.delete(a.taskId),e.reject(new Error(a.message))))}c.error(`Worker ${e} error: ${a.message}`),this.emit("workerError",{workerId:e,error:a})}handleWorkerError(e,t){c.error(`Worker ${e} encountered error: ${t.message}`);const a=this.workerInfos.get(e);a&&(a.status=p.ERROR,a.errorCount++),this.recreateWorker(e)}handleWorkerExit(e,t){c.warn(`Worker ${e} exited with code ${t}`),this.workers.delete(e);const a=this.workerInfos.get(e);a&&(a.status=p.TERMINATED),this.isShuttingDown||this.recreateWorker(e)}async recreateWorker(e){try{const t=this.workers.size,a=i(857).cpus().length,r=Math.min(2*a,16);if(t>=r)return void c.warn(`已达到最大Worker数量限制 (${r})，不再重建Worker ${e}`);this.workers.delete(e),this.workerInfos.delete(e),await this.createWorker(),c.info(`Worker ${e} recreated (${this.workers.size}/${r})`)}catch(e){c.error(`Failed to recreate worker: ${e}`)}}addTaskToQueue(e){let t=this.taskQueue.length;for(let a=0;a<this.taskQueue.length;a++)if(this.taskQueue[a].priority<e.priority){t=a;break}this.taskQueue.splice(t,0,e),this.stats.queuedTasks=this.taskQueue.length}processQueue(){if(0===this.taskQueue.length)return;const e=this.findIdleWorker();if(!e)return void(this.workers.size<this.config.maxWorkers&&this.createWorker().then((()=>this.processQueue())));const t=this.taskQueue.shift();t&&(this.stats.queuedTasks=this.taskQueue.length,this.assignTaskToWorker(e,t))}findIdleWorker(){for(const[e,t]of this.workerInfos)if(t.status===p.IDLE)return e;return null}assignTaskToWorker(e,t){const a=this.workers.get(e),r=this.workerInfos.get(e);if(!a||!r)return;r.status=p.BUSY,r.currentTaskId=t.id,t.startedAt=Date.now(),this.activeTasks.set(t.id,t),this.stats.processingTasks=this.activeTasks.size;const s={id:this.generateMessageId(),type:t.type,payload:t.data,timestamp:Date.now()};this.sendMessage(e,s),this.emit("taskStarted",{taskId:t.id,workerId:e}),c.debug(`Task ${t.id} assigned to worker ${e}`)}async sendMessage(e,t){const a=this.workers.get(e);if(!a)throw new Error(`Worker ${e} not found`);a.postMessage(t)}async terminateWorker(e){return new Promise((t=>{const a=setTimeout((()=>{e.terminate(),t()}),5e3);e.once("exit",(()=>{clearTimeout(a),t()})),e.postMessage({id:this.generateMessageId(),type:f.TERMINATE,payload:{},timestamp:Date.now()})}))}startHeartbeat(){this.heartbeatInterval=setInterval((()=>{this.performHeartbeat()}),this.config.heartbeatInterval)}performHeartbeat(){const e=Date.now();for(const[t,a]of this.workerInfos){if(e-a.lastActiveAt>this.config.workerTimeout){c.warn(`Worker ${t} appears to be unresponsive`),this.recreateWorker(t);continue}const r=this.workers.get(t);r&&a.status===p.IDLE&&r.postMessage({id:this.generateMessageId(),type:f.PING,payload:{},timestamp:e})}}updateStats(){let e=0,t=0;for(const a of this.workerInfos.values())a.status===p.BUSY?e++:a.status===p.IDLE&&t++;this.stats.activeWorkers=e,this.stats.idleWorkers=t,this.stats.queuedTasks=this.taskQueue.length,this.stats.processingTasks=this.activeTasks.size,this.stats.systemLoad=e/Math.max(1,this.workers.size)*100}generateWorkerId(){return`worker_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateTaskId(){return`task_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateMessageId(){return`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}startResourceMonitoring(){this.resourceMonitorInterval=setInterval((()=>{this.performResourceCheck()}),3e4)}performResourceCheck(){const e=process.memoryUsage(),t=this.getStats();c.debug("Resource check",{memory:`${Math.round(e.heapUsed/1024/1024)}MB`,workers:`${t.activeWorkers}/${this.config.maxWorkers}`,queue:t.queuedTasks}),(t.activeWorkers>0||t.queuedTasks>0)&&this.logWorkerProcessingStatus(),e.heapUsed>52428800&&(c.warn("High memory usage detected, cleaning up idle workers"),this.cleanupIdleWorkers()),t.activeWorkers>this.config.maxWorkers&&(c.warn("Too many active workers, forcing cleanup"),this.forceCleanupWorkers())}cleanupIdleWorkers(){const e=Date.now();for(const[t,a]of this.workerInfos)if(a.status===p.IDLE&&e-a.lastActiveAt>6e4){c.info(`Cleaning up idle worker: ${t}`);const e=this.workers.get(t);e&&this.terminateWorker(e)}}forceCleanupWorkers(){const e=Array.from(this.workerInfos.keys()),t=e.length-this.config.maxWorkers;if(t>0){const a=e.map((e=>({id:e,info:this.workerInfos.get(e)}))).sort(((e,t)=>e.info.status===p.IDLE&&t.info.status!==p.IDLE?-1:t.info.status===p.IDLE&&e.info.status!==p.IDLE?1:e.info.createdAt-t.info.createdAt));for(let e=0;e<t&&e<a.length;e++){const t=a[e].id,r=this.workers.get(t);r&&(c.warn(`Force terminating worker: ${t}`),this.terminateWorker(r))}}}}const y=require("fs/promises");class k{constructor(e){this.patterns=[],e&&this.parseGitIgnore(e)}parseGitIgnore(e){this.patterns=e.split("\n").map((e=>e.trim())).filter((e=>e&&!e.startsWith("#"))).map((e=>(e.startsWith("/")&&(e=e.substring(1)),e.endsWith("/")&&(e+="**"),e)))}shouldIgnore(e){return this.patterns.some((t=>this.matchPattern(t,e)))}matchPattern(e,t){return e.includes("*")?new RegExp("^"+e.replace(/\*\*/g,".*").replace(/\*/g,"[^/]*").replace(/\?/g,"[^/]").replace(/\./g,"\\.")+"$").test(t):t.includes(e)}}class v{constructor(e){this.workspaceRoot=e||this.getWorkspaceRoot(),this.defaultOptions={includePatterns:["**/*.java","**/*.xml"],excludePatterns:["**/node_modules/**","**/target/**","**/build/**","**/out/**","**/bin/**","**/.git/**","**/.vscode/**","**/.idea/**"],maxFileSize:10485760,recursive:!0,includeTests:!1,parseContent:!0,maxDepth:10}}async scanWorkspace(e){const t=Date.now(),a={...this.defaultOptions,...e};c.info("开始扫描工作空间文件...");try{await this.initializeGitIgnore();const e={totalFiles:0,javaFileCount:0,xmlFileCount:0,entityCount:0,mapperCount:0,directoriesScanned:0,skippedFiles:0,errorFiles:0},r=[],s=[];await this.scanDirectory(this.workspaceRoot,a,r,s,e,0),a.parseContent&&await this.parseFileContents(r,s,e);const i=Date.now()-t;return c.info(`文件扫描完成: ${e.totalFiles}个文件, 耗时${i}ms`),{javaFiles:r,xmlFiles:s,stats:e,scanTime:i}}catch(e){throw c.error(`文件扫描失败: ${e}`),e}}async initializeGitIgnore(){try{const e=await o.workspace.findFiles(".gitignore");if(e.length>0){const t=await o.workspace.fs.readFile(e[0]),a=Buffer.from(t).toString("utf8");this.gitIgnoreProcessor=new k(a),c.debug("已加载.gitignore文件")}else c.debug("未找到.gitignore文件")}catch(e){c.warn(`加载.gitignore文件失败: ${e}`)}}async scanDirectory(e,t,a,r,s,i){if(!(i>t.maxDepth))try{const n=await y.readdir(e,{withFileTypes:!0});s.directoriesScanned++;for(const o of n){const n=u.join(e,o.name),l=u.relative(this.workspaceRoot,n);this.gitIgnoreProcessor&&this.gitIgnoreProcessor.shouldIgnore(l)?(s.skippedFiles++,c.debug(`GitIgnore跳过: ${l}`)):this.shouldExclude(l,t.excludePatterns)?(s.skippedFiles++,c.debug(`排除模式跳过: ${l}`)):o.isDirectory()?t.recursive&&await this.scanDirectory(n,t,a,r,s,i+1):o.isFile()&&await this.processFile(n,l,t,a,r,s)}}catch(t){c.warn(`扫描目录失败 ${e}: ${t}`),s.errorFiles++}}async processFile(e,t,a,r,s,i){try{const n=u.basename(e),o=u.extname(n).toLowerCase();if(".java"!==o&&".xml"!==o)return;if(!a.includeTests&&this.isTestFile(t))return i.skippedFiles++,void c.debug(`测试文件跳过: ${t}`);const l=await y.stat(e);if(l.size>a.maxFileSize)return c.warn(`文件过大，跳过: ${t} (${l.size} bytes)`),void i.skippedFiles++;const h={filePath:e,relativePath:t,fileName:n,size:l.size,lastModified:l.mtime.getTime(),fileType:".java"===o?"java":"xml"};".java"===o?(r.push(h),i.javaFileCount++,c.debug(`发现Java文件: ${t}`)):".xml"===o&&(s.push(h),i.xmlFileCount++,c.debug(`发现XML文件: ${t}`)),i.totalFiles++}catch(t){c.warn(`处理文件失败 ${e}: ${t}`),i.errorFiles++}}async parseFileContents(e,t,a){c.info("开始解析文件内容...");for(const t of e)try{await this.parseJavaFile(t),t.isEntity&&a.entityCount++}catch(e){c.warn(`解析Java文件失败 ${t.relativePath}: ${e}`),a.errorFiles++}for(const e of t)try{await this.parseXmlFile(e),e.isMapper&&a.mapperCount++}catch(t){c.warn(`解析XML文件失败 ${e.relativePath}: ${t}`),a.errorFiles++}}async parseJavaFile(e){try{const t=await y.readFile(e.filePath,"utf-8"),a=t.match(/package\s+([\w.]+)\s*;/);a&&(e.packageName=a[1]),e.isEntity=this.isEntityClass(t,e.fileName)}catch(e){throw new Error(`读取Java文件失败: ${e}`)}}async parseXmlFile(e){try{const t=await y.readFile(e.filePath,"utf-8"),a=t.match(/namespace\s*=\s*["']([^"']+)["']/);a&&(e.namespace=a[1]),e.isMapper=this.isMapperFile(t,e.fileName)}catch(e){throw new Error(`读取XML文件失败: ${e}`)}}isEntityClass(e,t){const a=["@Entity","@Table","@TableName","@Data","@Component"];for(const t of a)if(e.includes(t))return!0;const r=["@Id","@Column","@TableId","@TableField"];for(const t of r)if(e.includes(t))return!0;const s=/public\s+\w+\s+get\w+\s*\(/.test(e),i=/public\s+void\s+set\w+\s*\(/.test(e);if(s&&i)return!0;if(/private\s+\w+\s+\w+\s*;/.test(e))return!0;const n=[/Entity\.java$/i,/Model\.java$/i,/DO\.java$/i,/PO\.java$/i,/VO\.java$/i,/DTO\.java$/i,/Bean\.java$/i];for(const e of n)if(e.test(t))return!0;const o=e.match(/package\s+([\w.]+)\s*;/);if(o){const e=o[1].toLowerCase(),t=["entity","model","domain","pojo","bean","dto","vo","po"];for(const a of t)if(e.includes(a))return!0}if(e.includes("implements Serializable")||e.includes("extends Serializable"))return!0;const c=["javax.persistence","com.baomidou.mybatisplus","org.springframework.data.jpa","lombok.Data","lombok.Entity"];for(const t of c)if(e.includes(`import ${t}`))return!0;if((e.match(/private\s+\w+\s+\w+\s*;/g)||[]).length>=2){const t=e.match(/(?:public\s+)?class\s+(\w+)/);if(t){const e=t[1];if(![/Util$/i,/Utils$/i,/Helper$/i,/Config$/i,/Configuration$/i,/Constants?$/i,/Factory$/i,/Builder$/i,/Manager$/i,/Service$/i,/Controller$/i,/Repository$/i,/Dao$/i].some((t=>t.test(e))))return!0}}return!1}isMapperFile(e,t){if(t.toLowerCase().includes("mapper"))return!0;const a=["<mapper","<select","<insert","<update","<delete","<resultMap"];for(const t of a)if(e.includes(t))return!0;return!1}isTestFile(e){return[/\/test\//,/\/tests\//,/Test\.java$/,/Tests\.java$/,/TestCase\.java$/,/_test\.java$/,/_tests\.java$/].some((t=>t.test(e)))}shouldExclude(e,t){return t.some((t=>new RegExp(t.replace(/\*\*/g,".*").replace(/\*/g,"[^/]*").replace(/\?/g,"[^/]")).test(e)))}getWorkspaceRoot(){const e=o.workspace.workspaceFolders;if(!e||0===e.length)throw new Error("没有打开的工作空间");return e[0].uri.fsPath}createFileWatcher(e){const t=o.workspace.createFileSystemWatcher(new o.RelativePattern(this.workspaceRoot,"**/*.{java,xml}")),a=[t.onDidCreate((t=>e("created",t.fsPath))),t.onDidChange((t=>e("changed",t.fsPath))),t.onDidDelete((t=>e("deleted",t.fsPath))),t];return o.Disposable.from(...a)}async getFileContent(e){try{return await y.readFile(e,"utf-8")}catch(t){throw new Error(`读取文件失败 ${e}: ${t}`)}}async fileExists(e){try{return await y.access(e),!0}catch{return!1}}async getFileStats(e){return await y.stat(e)}async getFileContents(e){const t=new Map,a=e.map((async e=>{try{const a=await this.getFileContent(e);t.set(e,a)}catch(t){c.warn(`读取文件失败 ${e}: ${t}`)}}));return await Promise.all(a),t}filterFiles(e,t){return e.filter((e=>!(t.fileType&&e.fileType!==t.fileType||void 0!==t.isEntity&&e.isEntity!==t.isEntity||void 0!==t.isMapper&&e.isMapper!==t.isMapper||t.packageName&&e.packageName!==t.packageName||t.namespace&&e.namespace!==t.namespace||t.minSize&&e.size<t.minSize||t.maxSize&&e.size>t.maxSize||t.modifiedAfter&&e.lastModified<t.modifiedAfter)))}getGitIgnoreStatus(){return{loaded:!!this.gitIgnoreProcessor,patternCount:this.gitIgnoreProcessor?this.gitIgnoreProcessor.patterns.length:0}}}class E{generateERDiagram(e){const{entities:t,relations:a}=e;if(!t||0===t.length)return this.generateEmptyDiagram();let r="erDiagram\n";return r+=this.generateEntities(t),a&&a.length>0&&(r+="\n",r+=this.generateRelations(a)),r}generateEmptyDiagram(){return'erDiagram\n    NO_ENTITIES {\n        string message "未找到MyBatis实体类"\n        string suggestion "请确保项目包含@TableName等注解的实体类"\n    }'}generateEntities(e){return e.map((e=>this.generateEntity(e))).join("\n\n")}generateEntity(e){let t=`    ${this.sanitizeTableName(e.tableName)} {\n`;e.fields&&e.fields.length>0?t+=e.fields.map((e=>this.generateField(e))).join("\n"):t+='        string placeholder "暂无字段信息"\n',t+="    }";const a=this.generateEntityComment(e);return a&&(t+=` %% ${a}`),t}generateField(e){return`        ${this.mapJavaTypeToDBType(e.javaType)} ${this.sanitizeColumnName(e.columnName)}${this.generateFieldConstraints(e)}`}generateFieldConstraints(e){const t=[];return e.isPrimaryKey&&t.push("PK"),e.isNotNull&&t.push("NOT NULL"),e.isUnique&&t.push("UNIQUE"),e.defaultValue&&t.push(`DEFAULT "${e.defaultValue}"`),e.comment&&t.push(`"${e.comment}"`),t.length>0?` ${t.join(" ")}`:""}generateEntityComment(e){const t=[];e.className&&t.push(`Java类: ${e.className}`),e.comment&&t.push(e.comment);const a=e.annotations.find((e=>"TableName"===e.name||"Table"===e.name));return a&&t.push(`注解: @${a.name}`),t.join(", ")}generateRelations(e){return e.map((e=>this.generateRelation(e))).join("\n")}generateRelation(e){const t=this.sanitizeTableName(e.fromTable),a=this.sanitizeTableName(e.toTable);let r=`    ${t} ${this.getRelationshipSymbol(e.type)} ${a}`;(e.fromField||e.toField)&&(r+=` : ${this.generateRelationLabel(e)}`);const s=this.generateRelationComment(e);return s&&(r+=` %% ${s}`),r}getRelationshipSymbol(e){switch(e.toLowerCase()){case"one-to-one":default:return"||--||";case"one-to-many":return"||--o{";case"many-to-one":return"}o--||";case"many-to-many":return"}o--o{"}}generateRelationLabel(e){const t=[];return e.fromField&&t.push(e.fromField),e.toField&&e.toField!==e.fromField&&t.push(e.toField),t.join("-")}generateRelationComment(e){const t=[];return void 0!==e.confidence&&t.push(`置信度: ${(100*e.confidence).toFixed(1)}%`),e.source&&t.push(`来源: ${e.source}`),e.description&&t.push(e.description),t.join(", ")}mapJavaTypeToDBType(e){return{String:"varchar",Integer:"int",int:"int",Long:"bigint",long:"bigint",Double:"double",double:"double",Float:"float",float:"float",Boolean:"boolean",boolean:"boolean",Date:"datetime",LocalDate:"date",LocalDateTime:"datetime",LocalTime:"time",Timestamp:"timestamp",BigDecimal:"decimal","byte[]":"blob","Byte[]":"blob"}[e.split("<")[0]]||"varchar"}sanitizeTableName(e){return e?e.replace(/[^a-zA-Z0-9_]/g,"_").toUpperCase():"UNKNOWN_TABLE"}sanitizeColumnName(e){return e?e.replace(/[^a-zA-Z0-9_]/g,"_").toLowerCase():"unknown_column"}generateThemedDiagram(e,t="default"){const a=this.generateERDiagram(e);return`%%{init: ${this.getThemeConfig(t)}}%%\n${a}`}getThemeConfig(e){const t={default:'{"theme": "default"}',dark:'{"theme": "dark"}',forest:'{"theme": "forest"}',neutral:'{"theme": "neutral"}'};return t[e]||t.default}generateStatistics(e){const{entities:t,relations:a}=e,r={entityCount:t.length,relationCount:a.length,fieldCount:t.reduce(((e,t)=>e+t.fields.length),0),relationTypes:{}};return a.forEach((e=>{const t=e.type;r.relationTypes[t]=(r.relationTypes[t]||0)+1})),r}validateMermaidCode(e){const t=[],a=[];e.trim().startsWith("erDiagram")||t.push('Mermaid代码必须以"erDiagram"开头');const r=e.match(/\s+\w+\s*\{[^}]*\}/g);r&&0!==r.length||a.push("未找到实体定义");const s=e.match(/\s+\w+\s+\|\|--[o\|]\{?\s+\w+/g);return s&&0!==s.length||a.push("未找到关系定义"),{isValid:0===t.length,errors:t,warnings:a}}}const T={entities:[{className:"User",tableName:"user",comment:"用户表",filePath:"/src/main/java/com/example/entity/User.java",annotations:[{name:"TableName",attributes:{value:"user"}}],fields:[{fieldName:"id",columnName:"id",javaType:"Long",isPrimaryKey:!0,isNotNull:!0,isUnique:!0,comment:"用户ID"},{fieldName:"username",columnName:"username",javaType:"String",isPrimaryKey:!1,isNotNull:!0,isUnique:!0,comment:"用户名"},{fieldName:"email",columnName:"email",javaType:"String",isPrimaryKey:!1,isNotNull:!0,isUnique:!0,comment:"邮箱"},{fieldName:"createTime",columnName:"create_time",javaType:"LocalDateTime",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"创建时间"}]},{className:"Order",tableName:"order",comment:"订单表",filePath:"/src/main/java/com/example/entity/Order.java",annotations:[{name:"TableName",attributes:{value:"order"}}],fields:[{fieldName:"id",columnName:"id",javaType:"Long",isPrimaryKey:!0,isNotNull:!0,isUnique:!0,comment:"订单ID"},{fieldName:"userId",columnName:"user_id",javaType:"Long",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"用户ID"},{fieldName:"orderNo",columnName:"order_no",javaType:"String",isPrimaryKey:!1,isNotNull:!0,isUnique:!0,comment:"订单号"},{fieldName:"totalAmount",columnName:"total_amount",javaType:"BigDecimal",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"总金额"},{fieldName:"status",columnName:"status",javaType:"Integer",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"订单状态"},{fieldName:"createTime",columnName:"create_time",javaType:"LocalDateTime",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"创建时间"}]},{className:"OrderItem",tableName:"order_item",comment:"订单项表",filePath:"/src/main/java/com/example/entity/OrderItem.java",annotations:[{name:"TableName",attributes:{value:"order_item"}}],fields:[{fieldName:"id",columnName:"id",javaType:"Long",isPrimaryKey:!0,isNotNull:!0,isUnique:!0,comment:"订单项ID"},{fieldName:"orderId",columnName:"order_id",javaType:"Long",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"订单ID"},{fieldName:"productId",columnName:"product_id",javaType:"Long",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"产品ID"},{fieldName:"quantity",columnName:"quantity",javaType:"Integer",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"数量"},{fieldName:"price",columnName:"price",javaType:"BigDecimal",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"单价"}]},{className:"Product",tableName:"product",comment:"产品表",filePath:"/src/main/java/com/example/entity/Product.java",annotations:[{name:"TableName",attributes:{value:"product"}}],fields:[{fieldName:"id",columnName:"id",javaType:"Long",isPrimaryKey:!0,isNotNull:!0,isUnique:!0,comment:"产品ID"},{fieldName:"name",columnName:"name",javaType:"String",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"产品名称"},{fieldName:"description",columnName:"description",javaType:"String",isPrimaryKey:!1,isNotNull:!1,isUnique:!1,comment:"产品描述"},{fieldName:"price",columnName:"price",javaType:"BigDecimal",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"价格"},{fieldName:"stock",columnName:"stock",javaType:"Integer",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"库存"}]}],relations:[{fromTable:"user",toTable:"order",fromField:"id",toField:"user_id",type:"one-to-many",confidence:.95,source:"naming-convention",description:"用户与订单的一对多关系"},{fromTable:"order",toTable:"order_item",fromField:"id",toField:"order_id",type:"one-to-many",confidence:.95,source:"naming-convention",description:"订单与订单项的一对多关系"},{fromTable:"product",toTable:"order_item",fromField:"id",toField:"product_id",type:"one-to-many",confidence:.95,source:"naming-convention",description:"产品与订单项的一对多关系"}]};class b{constructor(){this.testResults=new Map}static getInstance(){return b.instance||(b.instance=new b),b.instance}startTest(e){const t=new S(e);return c.info(`开始性能测试: ${e}`),t}recordResult(e){this.testResults.set(e.testName,e),c.info(`性能测试完成: ${e.testName}`,{duration:e.duration,memoryUsed:e.memoryUsed,itemsProcessed:e.itemsProcessed})}getTestReport(){const e=Array.from(this.testResults.values());return{totalTests:e.length,results:e,summary:{totalDuration:e.reduce(((e,t)=>e+t.duration),0),averageDuration:e.length>0?e.reduce(((e,t)=>e+t.duration),0)/e.length:0,maxMemoryUsed:Math.max(...e.map((e=>e.memoryUsed))),totalItemsProcessed:e.reduce(((e,t)=>e+t.itemsProcessed),0)}}}async showPerformanceReport(){const e=this.getTestReport(),t=`\n性能测试报告：\n\n总测试数: ${e.totalTests}\n总耗时: ${e.summary.totalDuration.toFixed(2)}ms\n平均耗时: ${e.summary.averageDuration.toFixed(2)}ms\n最大内存使用: ${(e.summary.maxMemoryUsed/1024/1024).toFixed(2)}MB\n总处理项目: ${e.summary.totalItemsProcessed}\n\n详细结果:\n${e.results.map((e=>`- ${e.testName}: ${e.duration.toFixed(2)}ms, ${(e.memoryUsed/1024/1024).toFixed(2)}MB, ${e.itemsProcessed}项`)).join("\n")}\n        `.trim();await o.window.showInformationMessage(t,{modal:!0})}clearResults(){this.testResults.clear(),c.info("性能测试结果已清除")}async runBenchmarkSuite(){c.info("开始运行基准测试套件"),this.clearResults();const e=this.startTest("内存使用基准");await this.simulateMemoryUsage(),e.finish(100);const t=this.startTest("解析速度基准");await this.simulateParsingLoad(),t.finish(500);const a=this.startTest("关系推断基准");await this.simulateInferenceLoad(),a.finish(200);const r=this.getTestReport();return c.info("基准测试套件完成",r.summary),r}async simulateMemoryUsage(){const e=[];for(let t=0;t<1e4;t++)e.push({id:t,name:`Entity_${t}`,fields:Array.from({length:10},((e,a)=>({name:`field_${a}`,type:"String",value:`value_${t}_${a}`})))});await new Promise((e=>setTimeout(e,100))),e.length=0}async simulateParsingLoad(){for(let e=0;e<500;e++)Array.from({length:10},((e,t)=>`@Column(name = "field_${t}") private String field${t};`)).join("\n"),await new Promise((e=>setTimeout(e,1)))}async simulateInferenceLoad(){for(let e=0;e<200;e++){const t=Array.from({length:50},((t,a)=>({name:`Entity${a}`,fields:["id","name",`entity${e}_id`]})));for(const e of t)for(const t of e.fields)t.endsWith("_id")&&Math.random();await new Promise((e=>setTimeout(e,1)))}}}class S{constructor(e){this.testName=e,this.startTime=performance.now(),this.startMemory=this.getMemoryUsage()}finish(e=0){const t=performance.now(),a=this.getMemoryUsage(),r={testName:this.testName,duration:t-this.startTime,memoryUsed:a-this.startMemory,itemsProcessed:e,timestamp:new Date};return b.getInstance().recordResult(r),r}getMemoryUsage(){return process.memoryUsage?process.memoryUsage().heapUsed:0}}class C{constructor(e,t,a){this.isProcessing=!1,this.stateManager=e,this.configManager=t,this.webviewProvider=a,this.workerManager=new w,this.fileScanner=new v,this.mermaidGenerator=new E}async initialize(){try{const e=this.configManager.getExtensionConfig().execution;e.useWorkerThreads&&!e.useMainThreadSerial?(c.info("配置为Worker线程模式，启动Worker管理器"),await this.workerManager.start(),c.info("Worker管理器初始化完成")):(c.info("配置为主线程串行模式，跳过Worker管理器启动"),c.info("Worker管理器将在需要时延迟初始化"))}catch(e){throw c.error("Worker管理器初始化失败",e),e}}async ensureWorkerManagerStarted(){const e=this.configManager.getExtensionConfig().execution;if(e.useWorkerThreads&&!e.useMainThreadSerial){const e=this.workerManager.getStats();0===e.activeWorkers&&0===e.idleWorkers&&(c.info("延迟启动Worker管理器"),await this.workerManager.start(),c.info("Worker管理器延迟初始化完成"))}}async dispose(){try{const e=this.workerManager.getStats();e.activeWorkers>0||e.idleWorkers>0?(await this.workerManager.shutdown(),c.info("Worker管理器已关闭")):c.info("Worker管理器未启动，跳过关闭操作")}catch(e){c.error("Worker管理器关闭失败",e)}}async handleGenerateERDiagram(){if(o.workspace.workspaceFolders)try{if(!await this.stateManager.isMyBatisProject()&&"继续"!==await o.window.showWarningMessage("当前工作空间似乎不是MyBatis项目，是否继续？","继续","取消"))return;const e=this.configManager.getExtensionConfig();if(c.info("开始生成ER图",{workspace:this.stateManager.getCurrentWorkspacePath(),config:this.configManager.getConfigSummary()}),e.autoRefresh&&this.stateManager.isCacheValid()&&"使用缓存"===await o.window.showInformationMessage("发现有效缓存，是否使用缓存数据？","使用缓存","重新生成")&&await this.stateManager.getERDiagramData())return c.info("使用缓存数据生成ER图"),void o.window.showInformationMessage("ER图生成完成（使用缓存）！");await o.window.withProgress({location:o.ProgressLocation.Notification,title:"正在生成ER图...",cancellable:!0},(async(e,t)=>{await this.performERGeneration(e,t)})),c.info("ER图生成完成"),o.window.showInformationMessage("ER图生成完成！")}catch(e){c.error("生成ER图失败",e),o.window.showErrorMessage(`生成ER图失败: ${e}`)}else o.window.showWarningMessage("请先打开一个工作空间")}async performERGeneration(e,t){e.report({increment:0,message:"扫描项目文件..."}),await this.stateManager.cleanExpiredCache();const a=await this.fileScanner.scanWorkspace({includeTests:this.configManager.getExtensionConfig().includeTestFiles});if(c.info(`文件扫描完成: ${a.stats.totalFiles}个文件`),e.report({increment:20,message:`发现${a.stats.entityCount}个实体类...`}),t.isCancellationRequested)throw new Error("用户取消了操作");const r=await this.batchProcessJavaFiles(a.javaFiles.filter((e=>e.isEntity)),e,t,20,25);e.report({increment:25,message:"解析XML映射文件..."});const s=await this.batchProcessXmlFiles(a.xmlFiles.filter((e=>e.isMapper)),e,t,25,25);if(e.report({increment:25,message:"推断实体关系..."}),t.isCancellationRequested)throw new Error("用户取消了操作");const i=await this.performRelationInference(r,s,t);if(e.report({increment:20,message:"生成ER图..."}),t.isCancellationRequested)throw new Error("用户取消了操作");const n=await this.generateERDiagramData(r,s,i),o={entities:n.entities,relations:n.relations,mermaidCode:n.mermaidCode,metadata:n.metadata,generatedAt:new Date,projectPath:this.stateManager.getCurrentWorkspacePath()||""};await this.stateManager.saveERDiagramData(o),this.webviewProvider.updateDiagram(o),e.report({increment:10,message:"完成"}),c.info("ER图生成完成",{entityCount:n.entities.length,relationCount:n.relations.length,scanStats:a.stats})}async batchProcessJavaFiles(e,t,a,r,s){if(0===e.length)return[];const i=this.configManager.getExtensionConfig().execution;return i.useWorkerThreads&&!i.useMainThreadSerial?(c.info("使用Worker线程模式处理Java文件"),this.batchProcessJavaFilesWorker(e,t,a,r,s)):(c.info("使用主线程串行模式处理Java文件（推荐）"),this.batchProcessJavaFilesSerial(e,t,a,r,s))}async batchProcessJavaFilesWorker(e,t,a,r,s){await this.ensureWorkerManagerStarted();const i=[],n=this.configManager.getExtensionConfig(),o=Math.min(n.execution.batchSize,Math.max(1,Math.floor(e.length/4))),l=this.chunkArray(e,o);c.info(`Worker模式批量处理Java文件: ${e.length}个文件，${l.length}个批次`);for(let e=0;e<l.length;e++){if(a.isCancellationRequested)throw new Error("用户取消了操作");const o=l[e],h=r+e*s/l.length;t.report({increment:h,message:`Worker处理Java文件批次 ${e+1}/${l.length} (${o.length}个文件)`});try{const t=await Promise.all(o.map((async e=>({filePath:e.filePath,content:await this.fileScanner.getFileContent(e.filePath),fileType:"java",options:{parseMethodBodies:!1}})))),a=await this.workerManager.submitTask(f.PARSE_BATCH_FILES,{files:t},{timeout:n.execution.timeout,maxRetries:1});Array.isArray(a)?i.push(...a):i.push(a),c.debug(`Worker批次 ${e+1} 处理完成，解析了 ${o.length} 个文件`)}catch(e){c.warn("Worker批量处理Java文件失败，尝试降级处理",e);for(const e of o)try{const t=await this.fileScanner.getFileContent(e.filePath),a=await this.parseJavaFileSync({filePath:e.filePath,content:t,fileType:"java",options:{parseMethodBodies:!1}});i.push(a)}catch(t){c.warn(`同步解析失败: ${e.filePath}`,t)}}e<l.length-1&&await new Promise((e=>setTimeout(e,100)))}return i}async batchProcessJavaFilesSerial(e,t,a,r,s){const i=[];this.configManager.getExtensionConfig(),c.info(`主线程串行处理Java文件: ${e.length}个文件`);for(let n=0;n<e.length;n++){if(a.isCancellationRequested)throw new Error("用户取消了操作");const o=e[n],l=r+n*s/e.length;t.report({increment:l,message:`主线程解析Java文件 ${n+1}/${e.length}: ${o.filePath.split("/").pop()}`});try{const e=await this.fileScanner.getFileContent(o.filePath),t=await this.parseJavaFileSync({filePath:o.filePath,content:e,fileType:"java",options:{parseMethodBodies:!1}});i.push(t),c.debug(`主线程解析完成: ${o.filePath}`)}catch(e){c.warn(`主线程解析Java文件失败: ${o.filePath}`,e)}n%5==0&&n>0&&await new Promise((e=>setTimeout(e,10)))}return i}async batchProcessXmlFiles(e,t,a,r,s){if(0===e.length)return[];const i=this.configManager.getExtensionConfig().execution;return i.useWorkerThreads&&!i.useMainThreadSerial?(c.info("使用Worker线程模式处理XML文件"),this.batchProcessXmlFilesWorker(e,t,a,r,s)):(c.info("使用主线程串行模式处理XML文件（推荐）"),this.batchProcessXmlFilesSerial(e,t,a,r,s))}async batchProcessXmlFilesWorker(e,t,a,r,s){await this.ensureWorkerManagerStarted();const i=[],n=this.configManager.getExtensionConfig(),o=Math.min(n.execution.batchSize,Math.max(1,Math.floor(e.length/3))),l=this.chunkArray(e,o);c.info(`Worker模式批量处理XML文件: ${e.length}个文件，${l.length}个批次`);for(let e=0;e<l.length;e++){if(a.isCancellationRequested)throw new Error("用户取消了操作");const o=l[e],h=r+e*s/l.length;t.report({increment:h,message:`Worker处理XML文件批次 ${e+1}/${l.length} (${o.length}个文件)`});try{const t=await Promise.all(o.map((async e=>({filePath:e.filePath,content:await this.fileScanner.getFileContent(e.filePath),fileType:"xml"})))),a=await this.workerManager.submitTask(f.PARSE_BATCH_FILES,{files:t},{timeout:n.execution.timeout,maxRetries:1});Array.isArray(a)?i.push(...a):i.push(a),c.debug(`Worker XML批次 ${e+1} 处理完成，解析了 ${o.length} 个文件`)}catch(e){c.warn("Worker批量处理XML文件失败，尝试降级处理",e);for(const e of o)try{const t=await this.fileScanner.getFileContent(e.filePath),a=await this.parseXmlFileSync({filePath:e.filePath,content:t,fileType:"xml"});i.push(a)}catch(t){c.warn(`同步解析XML失败: ${e.filePath}`,t)}}e<l.length-1&&await new Promise((e=>setTimeout(e,80)))}return i}async batchProcessXmlFilesSerial(e,t,a,r,s){const i=[];this.configManager.getExtensionConfig(),c.info(`主线程串行处理XML文件: ${e.length}个文件`);for(let n=0;n<e.length;n++){if(a.isCancellationRequested)throw new Error("用户取消了操作");const o=e[n],l=r+n*s/e.length;t.report({increment:l,message:`主线程解析XML文件 ${n+1}/${e.length}: ${o.filePath.split("/").pop()}`});try{const e=await this.fileScanner.getFileContent(o.filePath),t=await this.parseXmlFileSync({filePath:o.filePath,content:e,fileType:"xml"});i.push(t),c.debug(`主线程XML解析完成: ${o.filePath}`)}catch(e){c.warn(`主线程解析XML文件失败: ${o.filePath}`,e)}n%3==0&&n>0&&await new Promise((e=>setTimeout(e,10)))}return i}async performRelationInference(e,t,a){if(a.isCancellationRequested)throw new Error("用户取消了操作");try{const a=this.configManager.getExtensionConfig().execution;if(a.useWorkerThreads&&!a.useMainThreadSerial){await this.ensureWorkerManagerStarted();const a=this.configManager.getExtensionConfig().inferenceStrategies,r=[{name:"naming-convention",weight:.8,enabled:a.naming,minConfidence:.6},{name:"annotation-based",weight:.9,enabled:a.annotation,minConfidence:.7},{name:"xml-mapping",weight:.85,enabled:a.xml,minConfidence:.75},{name:"field-type-analysis",weight:.7,enabled:a.semantic,minConfidence:.5}];return await this.workerManager.submitTask(f.INFER_RELATIONS,{entities:e.filter((e=>e&&!1!==e.success)),mappings:t.filter((e=>e&&!1!==e.success)),strategies:r},{timeout:15e3,maxRetries:1})}return c.info("使用主线程模式进行关系推断"),this.performRelationInferenceSync(e,t)}catch(a){return c.warn("Worker关系推断失败，尝试同步推断",a),this.performRelationInferenceSync(e,t)}}async generateERDiagramData(e,t,a){const r=e.filter((e=>e&&!1!==e.success)),s=(t.filter((e=>e&&!1!==e.success)),a?.relations||[]);return{entities:r,relations:s,mermaidCode:this.mermaidGenerator.generateERDiagram({entities:r,relations:s,generatedAt:new Date,projectPath:this.stateManager.getCurrentWorkspacePath()||""}),metadata:{generatedAt:(new Date).toISOString(),totalEntities:r.length,totalRelations:s.length,confidence:a?.confidence||0,processingStats:{javaFiles:e.length,xmlFiles:t.length,workerStats:this.workerManager.getStats()}}}}async parseJavaFileSync(e){try{const{SmartJavaParser:t}=await i.e(531).then(i.bind(i,531)),a=new t,r=await a.parseJavaFile(e.filePath,e.content);return r?(c.debug(`主线程Java解析完成: ${e.filePath}`,{parseMethod:r.parseMethod,confidence:r.confidence,className:r.className,fieldCount:r.fields?.length||0}),{...r,filePath:e.filePath,success:!0,executionMode:"main-thread"}):(c.debug(`主线程Java解析未找到实体: ${e.filePath}`),{filePath:e.filePath,success:!1,reason:"not-entity-class",executionMode:"main-thread"})}catch(t){return c.warn(`主线程Java解析失败: ${e.filePath}`,t),{filePath:e.filePath,error:t.message,success:!1,executionMode:"main-thread"}}}async parseXmlFileSync(e){try{const{SmartXmlParser:t}=await i.e(536).then(i.bind(i,536)),a=new t;return await a.parseXmlFile(e.filePath,e.content)}catch(t){return c.warn(`同步XML解析失败: ${e.filePath}`,t),{filePath:e.filePath,error:t.message,success:!1}}}async performRelationInferenceSync(e,t){try{const{RelationInferenceEngine:a}=await i.e(301).then(i.bind(i,301)),r=new a,s=e.filter((e=>e&&!1!==e.success)),n=t.filter((e=>e&&!1!==e.success)),o=this.configManager.getExtensionConfig().inferenceStrategies,c=[{name:"naming-convention",weight:.8,enabled:o.naming,minConfidence:.6},{name:"annotation-based",weight:.9,enabled:o.annotation,minConfidence:.7},{name:"xml-mapping",weight:.85,enabled:o.xml,minConfidence:.75},{name:"field-type-analysis",weight:.7,enabled:o.semantic,minConfidence:.5}];return await r.inferRelations(s,n,{strategies:c})}catch(e){return c.warn("同步关系推断失败",e),{relations:[],confidence:0,error:e.message}}}chunkArray(e,t){const a=[];for(let r=0;r<e.length;r+=t)a.push(e.slice(r,r+t));return a}async handleRefreshERDiagram(){if(this.isProcessing)o.window.showWarningMessage("ER图生成正在进行中，请稍候...");else try{await this.stateManager.clearERDiagramData(),await this.stateManager.cleanExpiredCache(),await this.handleGenerateERDiagram()}catch(e){c.error("刷新ER图失败",e),o.window.showErrorMessage(`刷新ER图失败: ${e}`)}}async handleShowStatus(){try{const e=this.workerManager.getStats(),t=this.workerManager.getHealthStatus(),a=this.stateManager.getStateStats(),r=this.configManager.getConfigSummary(),s=process.memoryUsage(),i={"🔧 Worker状态":{活跃Worker:`${e.activeWorkers}/${e.activeWorkers+e.idleWorkers}`,队列任务:e.queuedTasks,处理中任务:e.processingTasks,已完成任务:e.totalProcessedTasks,平均队列时间:`${e.averageQueueTime}ms`},"💾 内存使用":{堆内存:`${Math.round(s.heapUsed/1024/1024)}MB`,总内存:`${Math.round(s.heapTotal/1024/1024)}MB`,外部内存:`${Math.round(s.external/1024/1024)}MB`},"🏥 健康状态":{状态:t.healthy?"✅ 健康":"⚠️ 异常",问题:t.issues.length>0?t.issues.join(", "):"无",建议:t.recommendations.length>0?t.recommendations.join(", "):"无"},"📊 缓存状态":a,"⚙️ 配置":r},n=Object.entries(i).map((([e,t])=>`${e}\n${Object.entries(t).map((([e,t])=>`  ${e}: ${t}`)).join("\n")}`)).join("\n\n"),c=await o.window.showInformationMessage("MyBatis ER Generator 状态信息",{modal:!0,detail:n},"复制到剪贴板","清理缓存","重启Worker");"复制到剪贴板"===c?(await o.env.clipboard.writeText(n),o.window.showInformationMessage("状态信息已复制到剪贴板")):"清理缓存"===c?await this.handleClearCache():"重启Worker"===c&&await this.restartWorkerManager()}catch(e){c.error("获取状态信息失败",e),o.window.showErrorMessage(`获取状态信息失败: ${e}`)}}async restartWorkerManager(){try{o.window.showInformationMessage("正在重启Worker管理器..."),await this.workerManager.shutdown();const e=this.getOptimizedWorkerConfig();this.workerManager=new w(e),await this.workerManager.start(),o.window.showInformationMessage("Worker管理器重启完成"),c.info("Worker管理器重启完成")}catch(e){c.error("重启Worker管理器失败",e),o.window.showErrorMessage(`重启Worker管理器失败: ${e}`)}}getOptimizedWorkerConfig(){const e=i(857).cpus().length;return{maxWorkers:Math.min(e,6),workerTimeout:1e4,maxQueueSize:30,heartbeatInterval:2e3,maxRetries:1,enableProfiling:!1}}async handleClearCache(){try{"确定"===await o.window.showWarningMessage("确定要清除所有缓存吗？这将删除已解析的数据。","确定","取消")&&(await this.stateManager.clearERDiagramData(),await this.stateManager.cleanExpiredCache(),this.workerManager.getStats().activeWorkers>0&&c.info("清理Worker状态"),o.window.showInformationMessage("缓存已清除"),c.info("用户手动清除缓存"))}catch(e){c.error("清除缓存失败",e),o.window.showErrorMessage(`清除缓存失败: ${e}`)}}async handleTestWebView(){try{c.info("加载测试数据到WebView"),this.mermaidGenerator.generateERDiagram(T),this.webviewProvider.updateDiagram(T),o.window.showInformationMessage("测试数据已加载到ER图视图！")}catch(e){c.error("加载测试数据失败",e),o.window.showErrorMessage(`加载测试数据失败: ${e}`)}}async handlePerformanceBenchmark(){try{c.info("开始运行性能基准测试"),await o.window.withProgress({location:o.ProgressLocation.Notification,title:"正在运行性能基准测试...",cancellable:!1},(async e=>{e.report({increment:0,message:"初始化测试环境..."});const t=b.getInstance();e.report({increment:30,message:"运行基准测试套件..."}),await t.runBenchmarkSuite(),e.report({increment:100,message:"测试完成"}),await t.showPerformanceReport()})),c.info("性能基准测试完成")}catch(e){c.error("性能基准测试失败",e),o.window.showErrorMessage(`性能基准测试失败: ${e}`)}}async handleSimpleTest(){try{c.info("开始简单功能测试");const e=this.workerManager.getStats();c.info("Worker状态",e);const t=this.stateManager.getStateStats();c.info("状态管理器",t);const a=this.configManager.getConfigSummary();c.info("配置管理器",a),o.window.showInformationMessage(`扩展功能测试完成！\nWorker状态: ${e.activeWorkers+e.idleWorkers}个Worker\n配置状态: 正常\n状态管理: 正常`),c.info("简单功能测试完成")}catch(e){c.error("简单功能测试失败",e),o.window.showErrorMessage(`功能测试失败: ${e}`)}}}class M{constructor(e,t){this._extensionUri=e,this._context=t}resolveWebviewView(e,t,a){this._view=e,e.webview.options={enableScripts:!0,localResourceRoots:[this._extensionUri]},e.webview.html=this._getHtmlForWebview(e.webview),e.webview.onDidReceiveMessage((e=>{switch(e.type){case"exportDiagram":this._exportDiagram(e.format);break;case"refreshDiagram":this._refreshDiagram();break;case"searchEntities":this._searchEntities(e.query);break;case"filterRelations":this._filterRelations(e.filter)}}),void 0,this._context.subscriptions)}updateDiagram(e){this._data=e,this._view&&this._view.webview.postMessage({type:"updateDiagram",data:e})}showLoading(e="正在生成ER图..."){this._view&&this._view.webview.postMessage({type:"showLoading",message:e})}showError(e){this._view&&this._view.webview.postMessage({type:"showError",error:e})}async _exportDiagram(e){if(this._data)try{const t=await o.window.showSaveDialog({defaultUri:o.Uri.file(`er-diagram.${e}`),filters:{[e.toUpperCase()]:[e]}});t&&this._view?.webview.postMessage({type:"exportToFile",format:e,path:t.fsPath})}catch(e){o.window.showErrorMessage(`导出失败: ${e}`)}else o.window.showWarningMessage("没有可导出的ER图数据")}async _refreshDiagram(){try{this.showLoading("正在刷新ER图..."),await o.commands.executeCommand("mybatis-er.generate")}catch(e){this.showError(`刷新失败: ${e}`)}}_searchEntities(e){this._view&&this._view.webview.postMessage({type:"searchResults",query:e,results:this._performSearch(e)})}_filterRelations(e){this._view&&this._view.webview.postMessage({type:"filterResults",filter:e,data:this._applyFilter(e)})}_performSearch(e){if(!this._data||!e.trim())return[];const t=e.toLowerCase();return this._data.entities.filter((e=>e.tableName.toLowerCase().includes(t)||e.className.toLowerCase().includes(t)||e.fields.some((e=>e.fieldName.toLowerCase().includes(t)||e.columnName.toLowerCase().includes(t)))))}_applyFilter(e){if(!this._data)return{entities:[],relations:[]};let t=this._data.entities,a=this._data.relations;return e.entityType&&(t=t.filter((t=>t.annotations.some((t=>t.name===e.entityType))))),e.relationType&&(a=a.filter((t=>t.type===e.relationType))),{entities:t,relations:a}}_getHtmlForWebview(e){const t=e.asWebviewUri(o.Uri.joinPath(this._extensionUri,"media","main.js")),a=e.asWebviewUri(o.Uri.joinPath(this._extensionUri,"media","mermaid-loader.js")),r=e.asWebviewUri(o.Uri.joinPath(this._extensionUri,"media","reset.css")),s=e.asWebviewUri(o.Uri.joinPath(this._extensionUri,"media","vscode.css")),i=e.asWebviewUri(o.Uri.joinPath(this._extensionUri,"media","main.css")),n=function(){let e="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let a=0;a<32;a++)e+=t.charAt(Math.floor(62*Math.random()));return e}();return`<!DOCTYPE html>\n            <html lang="zh-CN">\n            <head>\n                <meta charset="UTF-8">\n                <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${e.cspSource}; script-src 'nonce-${n}' 'unsafe-eval' https://cdn.jsdelivr.net; img-src ${e.cspSource} https:; connect-src https:;">\n                <meta name="viewport" content="width=device-width, initial-scale=1.0">\n                \n                <link href="${r}" rel="stylesheet">\n                <link href="${s}" rel="stylesheet">\n                <link href="${i}" rel="stylesheet">\n                \n                <title>MyBatis ER 图</title>\n            </head>\n            <body>\n                \x3c!-- 工具栏 --\x3e\n                <div class="toolbar">\n                    <div class="toolbar-group">\n                        <button id="refreshBtn" class="toolbar-btn" title="刷新ER图">\n                            <span class="codicon codicon-refresh"></span>\n                            刷新\n                        </button>\n                        <button id="exportBtn" class="toolbar-btn" title="导出ER图">\n                            <span class="codicon codicon-export"></span>\n                            导出\n                        </button>\n                    </div>\n                    \n                    <div class="toolbar-group">\n                        <input type="text" id="searchInput" placeholder="搜索实体或字段..." class="search-input">\n                        <button id="searchBtn" class="toolbar-btn" title="搜索">\n                            <span class="codicon codicon-search"></span>\n                        </button>\n                    </div>\n                    \n                    <div class="toolbar-group">\n                        <select id="filterSelect" class="filter-select">\n                            <option value="">全部关系</option>\n                            <option value="one-to-one">一对一</option>\n                            <option value="one-to-many">一对多</option>\n                            <option value="many-to-one">多对一</option>\n                            <option value="many-to-many">多对多</option>\n                        </select>\n                    </div>\n                </div>\n                \n                \x3c!-- 主要内容区域 --\x3e\n                <div class="main-content">\n                    \x3c!-- 侧边栏 --\x3e\n                    <div class="sidebar">\n                        <div class="sidebar-section">\n                            <h3>实体列表</h3>\n                            <div id="entityList" class="entity-list"></div>\n                        </div>\n                        \n                        <div class="sidebar-section">\n                            <h3>关系统计</h3>\n                            <div id="relationStats" class="relation-stats"></div>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- ER图画布 --\x3e\n                    <div class="diagram-container">\n                        <div id="loadingIndicator" class="loading-indicator" style="display: none;">\n                            <div class="loading-spinner"></div>\n                            <div class="loading-text">正在生成ER图...</div>\n                        </div>\n                        \n                        <div id="errorIndicator" class="error-indicator" style="display: none;">\n                            <div class="error-icon">⚠️</div>\n                            <div class="error-text"></div>\n                        </div>\n                        \n                        <div id="diagramCanvas" class="diagram-canvas"></div>\n                    </div>\n                </div>\n                \n                \x3c!-- 导出对话框 --\x3e\n                <div id="exportModal" class="modal" style="display: none;">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h3>导出ER图</h3>\n                            <button id="closeModal" class="close-btn">&times;</button>\n                        </div>\n                        <div class="modal-body">\n                            <div class="export-options">\n                                <label>\n                                    <input type="radio" name="exportFormat" value="png" checked>\n                                    PNG 图片\n                                </label>\n                                <label>\n                                    <input type="radio" name="exportFormat" value="svg">\n                                    SVG 矢量图\n                                </label>\n                                <label>\n                                    <input type="radio" name="exportFormat" value="pdf">\n                                    PDF 文档\n                                </label>\n                            </div>\n                        </div>\n                        <div class="modal-footer">\n                            <button id="confirmExport" class="btn btn-primary">导出</button>\n                            <button id="cancelExport" class="btn btn-secondary">取消</button>\n                        </div>\n                    </div>\n                </div>\n                \n                <script nonce="${n}" src="${a}"><\/script>\n                <script nonce="${n}" src="${t}"><\/script>\n            </body>\n            </html>`}}let R,P,$,x;async function I(e){c.initialize(),R=h.initialize(e),P=m.getInstance(),x=new M(e.extensionUri,e),e.subscriptions.push(o.window.registerWebviewViewProvider(M.viewType,x)),$=new C(R,P,x);try{await $.initialize(),c.info("Worker管理器初始化完成")}catch(e){return c.error("Worker管理器初始化失败",e),void o.window.showErrorMessage(`Worker管理器初始化失败: ${e}`)}c.info("MyBatis ER Generator 扩展已激活");const t=P.validateConfig();t.valid||(c.warn("配置验证失败",t.errors),o.window.showWarningMessage(`配置存在问题: ${t.errors.join(", ")}`));const a=o.commands.registerCommand("mybatis-er.generate",(()=>$.handleGenerateERDiagram())),r=o.commands.registerCommand("mybatis-er.refresh",(()=>$.handleRefreshERDiagram())),s=o.commands.registerCommand("mybatis-er.export",(()=>$.handleExportERDiagram())),n=o.commands.registerCommand("mybatis-er.settings",(()=>$.handleOpenSettings())),l=o.commands.registerCommand("mybatis-er.status",(()=>$.handleShowStatus())),d=o.commands.registerCommand("mybatis-er.clearCache",(()=>$.handleClearCache())),u=o.commands.registerCommand("mybatis-er.testWebView",(()=>$.handleTestWebView())),g=o.commands.registerCommand("mybatis-er.performanceBenchmark",(()=>$.handlePerformanceBenchmark())),f=o.commands.registerCommand("mybatis-er.simpleTest",(()=>$.handleSimpleTest())),p=o.commands.registerCommand("mybatis-er.javaExtensionDiagnostic",(async()=>{const{quickJavaExtensionDiagnostic:e}=await i.e(987).then(i.t.bind(i,987,23));return e()})),w=o.commands.registerCommand("mybatis-er.testWorkerThreadFix",(async()=>{const{testWorkerThreadFix:e}=await i.e(885).then(i.t.bind(i,885,23));return e()})),y=o.commands.registerCommand("mybatis-er.testVSCodeAPILoading",(async()=>{const{testVSCodeAPILoading:e}=await i.e(430).then(i.t.bind(i,430,23));return e()})),k=o.commands.registerCommand("mybatis-er.quickVSCodeTest",(async()=>{const{quickVSCodeTest:e,testJavaParserVSCodeAPI:t}=await i.e(104).then(i.t.bind(i,104,23));await e(),await t()})),v=P.onConfigChanged((e=>{c.info("配置已变更，重新应用设置",e)})),E=o.workspace.onDidChangeWorkspaceFolders((async e=>{c.info("工作空间已变更",{added:e.added.length,removed:e.removed.length}),e.removed.length>0&&await R.resetWorkspaceState()}));e.subscriptions.push(a,r,s,n,l,d,u,g,f,p,w,y,k,v,E,{dispose:()=>$.dispose()});const T=P.getConfigSummary(),b=R.getStateStats();o.window.showInformationMessage("MyBatis ER Generator 已就绪！"),c.info("扩展激活完成，所有命令已注册",{config:T,state:b})}async function W(){c.info("MyBatis ER Generator 扩展正在停用..."),$&&await $.dispose(),c.info("MyBatis ER Generator 扩展已停用"),c.dispose()}M.viewType="mybatis-er.erDiagramView",module.exports=n})();
//# sourceMappingURL=extension.js.map