(()=>{"use strict";var e,t,a,r={167:e=>{e.exports=require("worker_threads")},398:e=>{e.exports=require("vscode")},857:e=>{e.exports=require("os")}},s={};function i(e){var t=s[e];if(void 0!==t)return t.exports;var a=s[e]={exports:{}};return r[e](a,a.exports,i),a.exports}i.m=r,t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,i.t=function(a,r){if(1&r&&(a=this(a)),8&r)return a;if("object"==typeof a&&a){if(4&r&&a.__esModule)return a;if(16&r&&"function"==typeof a.then)return a}var s=Object.create(null);i.r(s);var n={};e=e||[null,t({}),t([]),t(t)];for(var o=2&r&&a;"object"==typeof o&&!~e.indexOf(o);o=t(o))Object.getOwnPropertyNames(o).forEach((e=>n[e]=()=>a[e]));return n.default=()=>a,i.d(s,n),s},i.d=(e,t)=>{for(var a in t)i.o(t,a)&&!i.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce(((t,a)=>(i.f[a](e,t),t)),[])),i.u=e=>e+".extension.js",i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a={792:1},i.f.require=(e,t)=>{a[e]||(e=>{var t=e.modules,r=e.ids,s=e.runtime;for(var n in t)i.o(t,n)&&(i.m[n]=t[n]);s&&s(i);for(var o=0;o<r.length;o++)a[r[o]]=1})(require("./"+i.u(e)))};var n={};i.r(n),i.d(n,{activate:()=>I,deactivate:()=>W});var o=i(398);class c{static initialize(){this.outputChannel=o.window.createOutputChannel("MyBatis ER Generator")}static info(e,...t){const a=`[${(new Date).toISOString()}] INFO: ${e}`;console.log(a,...t),this.outputChannel?.appendLine(a)}static warn(e,...t){const a=`[${(new Date).toISOString()}] WARN: ${e}`;console.warn(a,...t),this.outputChannel?.appendLine(a)}static error(e,t,...a){const r=`[${(new Date).toISOString()}] ERROR: ${e}`,s=t?`\n${t.stack}`:"";console.error(r,t,...a),this.outputChannel?.appendLine(r+s)}static debug(e,...t){const a=`[${(new Date).toISOString()}] DEBUG: ${e}`;console.debug(a,...t),this.outputChannel?.appendLine(a)}static show(){this.outputChannel?.show()}static clear(){this.outputChannel?.clear()}static dispose(){this.outputChannel?.dispose()}}const l=class e{constructor(e){this.context=e,this.workspaceState=e.workspaceState,this.globalState=e.globalState,c.info("çŠ¶æ€ç®¡ç†å™¨å·²åˆå§‹åŒ–")}static initialize(t){return e.instance||(e.instance=new e(t)),e.instance}static getInstance(){if(!e.instance)throw new Error("StateManageræœªåˆå§‹åŒ–ï¼Œè¯·å…ˆè°ƒç”¨initialize()");return e.instance}async saveERDiagramData(t){try{await this.workspaceState.update(e.KEYS.ER_DIAGRAM_DATA,{...t,generatedAt:t.generatedAt.toISOString()}),await this.workspaceState.update(e.KEYS.LAST_SCAN_TIME,Date.now()),c.info(`ERå›¾æ•°æ®å·²ä¿å­˜ï¼ŒåŒ…å«${t.entities.length}ä¸ªå®ä½“ï¼Œ${t.relations.length}ä¸ªå…³ç³»`)}catch(e){throw c.error("ä¿å­˜ERå›¾æ•°æ®å¤±è´¥",e),e}}async getERDiagramData(){try{const t=this.workspaceState.get(e.KEYS.ER_DIAGRAM_DATA);if(!t)return;return{...t,generatedAt:new Date(t.generatedAt)}}catch(e){return void c.error("è·å–ERå›¾æ•°æ®å¤±è´¥",e)}}async clearERDiagramData(){try{await this.workspaceState.update(e.KEYS.ER_DIAGRAM_DATA,void 0),await this.workspaceState.update(e.KEYS.LAST_SCAN_TIME,void 0),c.info("ERå›¾æ•°æ®å·²æ¸…é™¤")}catch(e){throw c.error("æ¸…é™¤ERå›¾æ•°æ®å¤±è´¥",e),e}}async saveProjectConfig(t){try{const a={...await this.getProjectConfig(),...t};await this.workspaceState.update(e.KEYS.PROJECT_CONFIG,a),c.info("é¡¹ç›®é…ç½®å·²ä¿å­˜",a)}catch(e){throw c.error("ä¿å­˜é¡¹ç›®é…ç½®å¤±è´¥",e),e}}async getProjectConfig(){try{return{autoRefresh:!0,includeTestFiles:!1,inferenceStrategies:{naming:!0,xml:!0,annotation:!0,semantic:!0},theme:"auto",exportFormat:"png",execution:{useWorkerThreads:!1,useMainThreadSerial:!0,maxConcurrency:4,batchSize:10,timeout:3e4},...this.workspaceState.get(e.KEYS.PROJECT_CONFIG)}}catch(e){return c.error("è·å–é¡¹ç›®é…ç½®å¤±è´¥",e),{autoRefresh:!0,includeTestFiles:!1,inferenceStrategies:{naming:!0,xml:!0,annotation:!0,semantic:!0},theme:"auto",exportFormat:"png",execution:{useWorkerThreads:!1,useMainThreadSerial:!0,maxConcurrency:4,batchSize:10,timeout:3e4}}}}getLastScanTime(){return this.workspaceState.get(e.KEYS.LAST_SCAN_TIME)}isCacheValid(e=3e5){const t=this.getLastScanTime();return!!t&&Date.now()-t<e}async saveEntityCache(t,a){try{const r=this.workspaceState.get(e.KEYS.WORKSPACE_ENTITIES)||{};r[t]={data:a,timestamp:Date.now()},await this.workspaceState.update(e.KEYS.WORKSPACE_ENTITIES,r)}catch(e){c.error("ä¿å­˜å®ä½“ç¼“å­˜å¤±è´¥",e)}}getEntityCache(t){try{const a=(this.workspaceState.get(e.KEYS.WORKSPACE_ENTITIES)||{})[t];if(!a)return;if(Date.now()-a.timestamp>3e5)return;return a.data}catch(e){return void c.error("è·å–å®ä½“ç¼“å­˜å¤±è´¥",e)}}async cleanExpiredCache(){try{const t=this.workspaceState.get(e.KEYS.WORKSPACE_ENTITIES)||{},a=Date.now(),r=3e5,s={};let i=0;for(const[e,n]of Object.entries(t))a-n.timestamp<=r?s[e]=n:i++;i>0&&(await this.workspaceState.update(e.KEYS.WORKSPACE_ENTITIES,s),c.info(`æ¸…é™¤äº†${i}ä¸ªè¿‡æœŸç¼“å­˜é¡¹`))}catch(e){c.error("æ¸…é™¤è¿‡æœŸç¼“å­˜å¤±è´¥",e)}}getCurrentWorkspacePath(){const e=o.workspace.workspaceFolders;return e?.[0]?.uri.fsPath}async isMyBatisProject(){if(!this.getCurrentWorkspacePath())return!1;try{const e=await o.workspace.findFiles("**/{*.xml,pom.xml,build.gradle,application.yml,application.properties}","**/node_modules/**",10),t=await o.workspace.findFiles(".gitignore");if(t.length>0){const a=await o.workspace.fs.readFile(t[0]),r=Buffer.from(a).toString("utf8").split("\n").map((e=>e.trim())).filter((e=>e&&!e.startsWith("#"))),s=e.filter((e=>{const t=o.workspace.asRelativePath(e);return!r.some((e=>e.includes("*")?new RegExp(e.replace(/\*/g,".*")).test(t):t.includes(e)))}));e.splice(0,e.length,...s)}for(const t of e){const e=await o.workspace.fs.readFile(t),a=Buffer.from(e).toString("utf8");if(a.includes("mybatis")||a.includes("MyBatis")||a.includes("mybatis-plus")||a.includes("com.baomidou"))return!0}return!1}catch(e){return c.error("æ£€æŸ¥MyBatisé¡¹ç›®å¤±è´¥",e),!1}}async saveGlobalSetting(e,t){try{await this.globalState.update(e,t),c.debug(`å…¨å±€è®¾ç½®å·²ä¿å­˜: ${e}`)}catch(e){throw c.error("ä¿å­˜å…¨å±€è®¾ç½®å¤±è´¥",e),e}}getGlobalSetting(e,t){return void 0!==t?this.globalState.get(e,t):this.globalState.get(e)}async resetWorkspaceState(){try{const t=Object.values(e.KEYS);for(const e of t)await this.workspaceState.update(e,void 0);c.info("å·¥ä½œç©ºé—´çŠ¶æ€å·²é‡ç½®")}catch(e){throw c.error("é‡ç½®å·¥ä½œç©ºé—´çŠ¶æ€å¤±è´¥",e),e}}getStateStats(){const t=this.getLastScanTime();return{workspacePath:this.getCurrentWorkspacePath(),lastScanTime:t?new Date(t).toISOString():null,cacheValid:this.isCacheValid(),hasERData:!!this.workspaceState.get(e.KEYS.ER_DIAGRAM_DATA)}}};l.KEYS={ER_DIAGRAM_DATA:"erDiagramData",LAST_SCAN_TIME:"lastScanTime",PROJECT_CONFIG:"projectConfig",CACHE_VERSION:"cacheVersion",WORKSPACE_ENTITIES:"workspaceEntities",INFERENCE_CACHE:"inferenceCache"};let h=l;class m{constructor(){this.configChangeListeners=[],o.workspace.onDidChangeConfiguration(this.onConfigurationChanged.bind(this)),c.info("é…ç½®ç®¡ç†å™¨å·²åˆå§‹åŒ–")}static getInstance(){return m.instance||(m.instance=new m),m.instance}getExtensionConfig(){const e=o.workspace.getConfiguration("mybatis-er");return{autoRefresh:e.get("autoRefresh",!0),includeTestFiles:e.get("includeTestFiles",!1),inferenceStrategies:e.get("inferenceStrategies",{naming:!0,xml:!0,annotation:!0,semantic:!0}),theme:e.get("theme","auto"),exportFormat:e.get("exportFormat","png"),execution:e.get("execution",{useWorkerThreads:!1,useMainThreadSerial:!0,maxConcurrency:2,batchSize:5,timeout:15e3})}}async updateExtensionConfig(e,t,a){try{const r=o.workspace.getConfiguration("mybatis-er");await r.update(e,t,a||o.ConfigurationTarget.Workspace),c.info(`é…ç½®å·²æ›´æ–°: ${e} = ${JSON.stringify(t)}`)}catch(t){throw c.error(`æ›´æ–°é…ç½®å¤±è´¥: ${e}`,t),t}}getWorkspaceConfig(){return{javaHome:this.getJavaConfig("home"),javaSourcePaths:this.getJavaConfig("sourcePaths",[]),includePatterns:this.getFileConfig("include",["**/*.java","**/*.xml"]),excludePatterns:this.getFileConfig("exclude",["**/node_modules/**","**/target/**","**/build/**","**/.git/**"]),tabSize:this.getEditorConfig("tabSize",4),insertSpaces:this.getEditorConfig("insertSpaces",!0),searchMaxResults:this.getSearchConfig("maxResults",1e3),searchTimeout:this.getSearchConfig("timeout",1e4)}}getJavaConfig(e,t){return o.workspace.getConfiguration("java").get(e,t)}getFileConfig(e,t){return o.workspace.getConfiguration("files").get(e,t)}getEditorConfig(e,t){return o.workspace.getConfiguration("editor").get(e,t)}getSearchConfig(e,t){return o.workspace.getConfiguration("search").get(e,t)}getMyBatisConfig(){const e=o.workspace.getConfiguration("mybatis-er");return{parseTimeout:e.get("parseTimeout",3e4),maxFileSize:e.get("maxFileSize",10485760),inferenceTimeout:e.get("inferenceTimeout",1e4),minConfidence:e.get("minConfidence",.6),cacheEnabled:e.get("cacheEnabled",!0),cacheMaxAge:e.get("cacheMaxAge",3e5),maxEntitiesInView:e.get("maxEntitiesInView",500),animationEnabled:e.get("animationEnabled",!0),exportPath:e.get("exportPath",""),exportQuality:e.get("exportQuality",1)}}getPerformanceConfig(){const e=o.workspace.getConfiguration("mybatis-er");return{maxWorkers:e.get("maxWorkers",Math.max(2,Math.floor(i(857).cpus().length/2))),workerTimeout:e.get("workerTimeout",3e4),maxMemoryUsage:e.get("maxMemoryUsage",104857600),gcThreshold:e.get("gcThreshold",.8),maxConcurrentParsing:e.get("maxConcurrentParsing",4),batchSize:e.get("batchSize",50),enableProfiling:e.get("enableProfiling",!1),logLevel:e.get("logLevel","info")}}validateConfig(){const e=[],t=this.getExtensionConfig(),a=this.getMyBatisConfig(),r=this.getPerformanceConfig();"boolean"!=typeof t.autoRefresh&&e.push("autoRefreshå¿…é¡»æ˜¯å¸ƒå°”å€¼"),["auto","light","dark"].includes(t.theme)||e.push("themeå¿…é¡»æ˜¯autoã€lightæˆ–darkä¹‹ä¸€"),["png","svg","pdf","mermaid"].includes(t.exportFormat)||e.push("exportFormatå¿…é¡»æ˜¯pngã€svgã€pdfæˆ–mermaidä¹‹ä¸€");const s=t.inferenceStrategies;if("object"!=typeof s||null===s)e.push("inferenceStrategieså¿…é¡»æ˜¯å¯¹è±¡");else{const t=["naming","xml","annotation","semantic"];for(const a of t)"boolean"!=typeof s[a]&&e.push(`inferenceStrategies.${a}å¿…é¡»æ˜¯å¸ƒå°”å€¼`)}return(r.maxWorkers<1||r.maxWorkers>16)&&e.push("maxWorkerså¿…é¡»åœ¨1-16ä¹‹é—´"),(a.minConfidence<0||a.minConfidence>1)&&e.push("minConfidenceå¿…é¡»åœ¨0-1ä¹‹é—´"),{valid:0===e.length,errors:e}}async resetToDefaults(){try{const e=o.workspace.getConfiguration("mybatis-er"),t=["autoRefresh","inferenceStrategies","theme","exportFormat","parseTimeout","maxFileSize","inferenceTimeout","minConfidence","cacheEnabled","cacheMaxAge","maxEntitiesInView","animationEnabled"];for(const a of t)await e.update(a,void 0,o.ConfigurationTarget.Workspace);c.info("é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼")}catch(e){throw c.error("é‡ç½®é…ç½®å¤±è´¥",e),e}}exportConfig(){return{extension:this.getExtensionConfig(),workspace:this.getWorkspaceConfig(),mybatis:this.getMyBatisConfig(),performance:this.getPerformanceConfig(),timestamp:(new Date).toISOString()}}async importConfig(e){try{if(!e.extension)throw new Error("æ— æ•ˆçš„é…ç½®æ•°æ®");const t=e.extension,a=o.workspace.getConfiguration("mybatis-er");for(const[e,r]of Object.entries(t))await a.update(e,r,o.ConfigurationTarget.Workspace);c.info("é…ç½®å¯¼å…¥æˆåŠŸ")}catch(e){throw c.error("å¯¼å…¥é…ç½®å¤±è´¥",e),e}}onConfigChanged(e){return this.configChangeListeners.push(e),new o.Disposable((()=>{const t=this.configChangeListeners.indexOf(e);t>=0&&this.configChangeListeners.splice(t,1)}))}onConfigurationChanged(e){if(e.affectsConfiguration("mybatis-er")){const e=this.getExtensionConfig();c.info("é…ç½®å·²å˜æ›´",e),this.configChangeListeners.forEach((t=>{try{t(e)}catch(e){c.error("é…ç½®å˜æ›´ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥",e)}}))}}getConfigSummary(){const e=this.validateConfig(),t=this.getExtensionConfig(),a=this.getPerformanceConfig();return{valid:e.valid,errors:e.errors,autoRefresh:t.autoRefresh,enabledStrategies:Object.entries(t.inferenceStrategies).filter((([e,t])=>t)).map((([e,t])=>e)),theme:t.theme,maxWorkers:a.maxWorkers,cacheEnabled:this.getMyBatisConfig().cacheEnabled}}}var d=i(167);const u=require("path"),g=require("events");var f=(e=>(e.PARSE_JAVA_FILE="PARSE_JAVA_FILE",e.PARSE_XML_FILE="PARSE_XML_FILE",e.PARSE_BATCH_FILES="PARSE_BATCH_FILES",e.INFER_RELATIONS="INFER_RELATIONS",e.VALIDATE_RELATIONS="VALIDATE_RELATIONS",e.GENERATE_DIAGRAM="GENERATE_DIAGRAM",e.EXPORT_DIAGRAM="EXPORT_DIAGRAM",e.PING="PING",e.PONG="PONG",e.TERMINATE="TERMINATE",e.ERROR="ERROR",e.PROGRESS="PROGRESS",e))(f||{}),p=(e=>(e.IDLE="idle",e.BUSY="busy",e.ERROR="error",e.TERMINATED="terminated",e))(p||{});class w extends g.EventEmitter{constructor(e={}){super(),this.workers=new Map,this.workerInfos=new Map,this.taskQueue=[],this.activeTasks=new Map,this.pendingResponses=new Map,this.isShuttingDown=!1;const t=i(857).cpus().length;this.config={maxWorkers:Math.min(2*t,16),workerTimeout:3e4,maxQueueSize:100,heartbeatInterval:5e3,maxRetries:3,enableProfiling:!1,...e},this.stats={activeWorkers:0,idleWorkers:0,queuedTasks:0,processingTasks:0,totalProcessedTasks:0,averageQueueTime:0,systemLoad:0},this.startHeartbeat(),this.startResourceMonitoring(),c.info("WorkerManager initialized with optimized config",{maxWorkers:this.config.maxWorkers,timeout:this.config.workerTimeout,queueSize:this.config.maxQueueSize})}async start(){if(this.isShuttingDown)throw new Error("WorkerManager is shutting down");try{await this.createWorker(),c.info("WorkerManager started with 1 initial worker")}catch(e){throw c.error("Failed to create initial worker",e),e}}async shutdown(){this.isShuttingDown=!0,this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.resourceMonitorInterval&&clearInterval(this.resourceMonitorInterval),this.taskQueue=[];for(const[e,t]of this.pendingResponses)clearTimeout(t.timeout),t.reject(new Error("WorkerManager is shutting down"));this.pendingResponses.clear();const e=Array.from(this.workers.values()).map((e=>this.terminateWorker(e)));await Promise.all(e),this.workers.clear(),this.workerInfos.clear(),this.activeTasks.clear(),c.info("WorkerManager shutdown completed")}async submitTask(e,t,a={}){if(this.isShuttingDown)throw new Error("WorkerManager is shutting down");if(this.taskQueue.length>=this.config.maxQueueSize)throw new Error("Task queue is full");const r={id:this.generateTaskId(),type:e,data:t,priority:a.priority||5,timeout:a.timeout||this.config.workerTimeout,retryCount:0,maxRetries:a.maxRetries||this.config.maxRetries,createdAt:Date.now()};return new Promise(((e,t)=>{this.addTaskToQueue(r);const a=setTimeout((()=>{this.pendingResponses.delete(r.id),t(new Error(`Task ${r.id} timed out after ${r.timeout}ms`))}),r.timeout);this.pendingResponses.set(r.id,{resolve:e,reject:t,timeout:a}),this.processQueue()}))}async submitBatchTasks(e){if(0===e.length)return[];if(e.length<=10)return Promise.all(e.map((e=>this.submitTask(e.type,e.data,e.options))));const t=[];for(let a=0;a<e.length;a+=5){const r=e.slice(a,a+5),s=await Promise.all(r.map((e=>this.submitTask(e.type,e.data,e.options))));t.push(...s),a+5<e.length&&await new Promise((e=>setTimeout(e,100)))}return t}getStats(){return this.updateStats(),{...this.stats}}getWorkerInfos(){return Array.from(this.workerInfos.values())}getWorkerProcessingDetails(){const e=[];for(const[t,a]of this.workerInfos){const r={workerId:t,status:a.status,processedTasks:a.processedTasks,errorCount:a.errorCount};if(a.currentTaskId){const e=this.activeTasks.get(a.currentTaskId);e&&(r.currentTask={id:e.id,type:e.type,startedAt:e.startedAt||e.createdAt,duration:Date.now()-(e.startedAt||e.createdAt),description:this.getTaskDescription(e)})}e.push(r)}return e}getTaskDescription(e){switch(e.type){case f.PARSE_JAVA_FILE:return`è§£æJavaæ–‡ä»¶: ${e.data?.filePath||"æœªçŸ¥æ–‡ä»¶"}`;case f.PARSE_XML_FILE:return`è§£æXMLæ–‡ä»¶: ${e.data?.filePath||"æœªçŸ¥æ–‡ä»¶"}`;case f.PARSE_BATCH_FILES:return`æ‰¹é‡è§£ææ–‡ä»¶: ${e.data?.files?.length||0}ä¸ªæ–‡ä»¶`;case f.INFER_RELATIONS:return`æ¨æ–­å…³ç³»: ${e.data?.entities?.length||0}ä¸ªå®ä½“`;case f.VALIDATE_RELATIONS:return`éªŒè¯å…³ç³»: ${e.data?.relations?.length||0}ä¸ªå…³ç³»`;case f.GENERATE_DIAGRAM:return`ç”Ÿæˆå›¾è¡¨: ${e.data?.entities?.length||0}ä¸ªå®ä½“`;case f.EXPORT_DIAGRAM:return`å¯¼å‡ºå›¾è¡¨: ${e.data?.format||"æœªçŸ¥æ ¼å¼"}`;default:return`æ‰§è¡Œä»»åŠ¡: ${e.type}`}}logWorkerProcessingStatus(){const e=this.getWorkerProcessingDetails(),t=this.getStats();c.info("=== Workerå¤„ç†çŠ¶æ€æŠ¥å‘Š ==="),c.info(`æ€»Workeræ•°: ${this.workers.size}/${this.config.maxWorkers}`),c.info(`æ´»è·ƒWorker: ${t.activeWorkers}, ç©ºé—²Worker: ${t.idleWorkers}`),c.info(`é˜Ÿåˆ—ä»»åŠ¡: ${t.queuedTasks}, å¤„ç†ä¸­ä»»åŠ¡: ${t.processingTasks}`),e.forEach((e=>{if(e.status===p.BUSY&&e.currentTask){const t=e.currentTask,a=Math.round(t.duration/1e3);c.info(`ğŸ”„ Worker ${e.workerId}: ${t.description} (${a}ç§’)`)}else c.info(`ğŸ’¤ Worker ${e.workerId}: ${e.status} (å·²å¤„ç†${e.processedTasks}ä¸ªä»»åŠ¡)`)})),c.info("========================")}getHealthStatus(){const e=[],t=[],a=this.getStats();return process.memoryUsage().heapUsed>52428800&&(e.push("å†…å­˜ä½¿ç”¨è¿‡é«˜"),t.push("è€ƒè™‘æ¸…ç†ç¼“å­˜æˆ–å‡å°‘å¹¶å‘ä»»åŠ¡")),a.activeWorkers>this.config.maxWorkers&&(e.push("Workeræ•°é‡è¶…é™"),t.push("ç­‰å¾…å½“å‰ä»»åŠ¡å®Œæˆæˆ–é‡å¯æ‰©å±•")),a.queuedTasks>.8*this.config.maxQueueSize&&(e.push("ä»»åŠ¡é˜Ÿåˆ—æ¥è¿‘æ»¡è½½"),t.push("å‡å°‘å¹¶å‘æ“ä½œæˆ–å¢åŠ å¤„ç†èƒ½åŠ›")),{healthy:0===e.length,issues:e,recommendations:t}}async createWorker(){const e=this.generateWorkerId(),t=u.join(__dirname,"workers","worker-thread.js");try{const a=new d.Worker(t,{workerData:{workerId:e,config:this.config},env:{...process.env,NODE_ENV:"worker"}});return this.workers.set(e,a),this.workerInfos.set(e,{id:e,status:p.IDLE,processedTasks:0,errorCount:0,createdAt:Date.now(),lastActiveAt:Date.now(),averageProcessingTime:0}),this.setupWorkerListeners(a,e),c.info(`Worker created: ${e}`),e}catch(t){throw c.error(`Failed to create worker: ${e}`,t),this.workerInfos.delete(e),t}}setupWorkerListeners(e,t){e.on("message",(e=>{this.handleWorkerMessage(t,e)})),e.on("error",(e=>{this.handleWorkerError(t,e)})),e.on("exit",(e=>{this.handleWorkerExit(t,e)}))}handleWorkerMessage(e,t){const a=this.workerInfos.get(e);if(a)switch(a.lastActiveAt=Date.now(),t.type){case f.PONG:break;case f.PROGRESS:this.emit("progress",t.payload);break;case f.ERROR:this.handleTaskError(e,t);break;default:t.isResponse&&t.responseToId&&this.handleTaskResponse(e,t)}}handleTaskResponse(e,t){const a=t.responseToId,r=this.pendingResponses.get(a),s=this.activeTasks.get(a),i=this.workerInfos.get(e);if(!r||!s||!i)return;clearTimeout(r.timeout),this.pendingResponses.delete(a),this.activeTasks.delete(a),i.status=p.IDLE,i.currentTaskId=void 0,i.processedTasks++;const n=Date.now()-(s.startedAt||s.createdAt);i.averageProcessingTime=(i.averageProcessingTime*(i.processedTasks-1)+n)/i.processedTasks,s.completedAt=Date.now(),this.stats.totalProcessedTasks++;const o=t.payload;o.success?(r.resolve(o.data),this.emit("taskCompleted",{taskId:a,workerId:e,result:o.data})):(r.reject(new Error(o.error||"Task failed")),this.emit("taskFailed",{taskId:a,workerId:e,error:o.error})),this.processQueue()}handleTaskError(e,t){const a=t.payload,r=this.workerInfos.get(e);if(r&&(r.errorCount++,r.status=p.ERROR),a.taskId){const e=this.pendingResponses.get(a.taskId),t=this.activeTasks.get(a.taskId);e&&t&&(t.retryCount<t.maxRetries?(t.retryCount++,this.addTaskToQueue(t),c.warn(`Retrying task ${t.id}, attempt ${t.retryCount}/${t.maxRetries}`)):(clearTimeout(e.timeout),this.pendingResponses.delete(a.taskId),this.activeTasks.delete(a.taskId),e.reject(new Error(a.message))))}c.error(`Worker ${e} error: ${a.message}`),this.emit("workerError",{workerId:e,error:a})}handleWorkerError(e,t){c.error(`Worker ${e} encountered error: ${t.message}`);const a=this.workerInfos.get(e);a&&(a.status=p.ERROR,a.errorCount++),this.recreateWorker(e)}handleWorkerExit(e,t){c.warn(`Worker ${e} exited with code ${t}`),this.workers.delete(e);const a=this.workerInfos.get(e);a&&(a.status=p.TERMINATED),this.isShuttingDown||this.recreateWorker(e)}async recreateWorker(e){try{const t=this.workers.size,a=i(857).cpus().length,r=Math.min(2*a,16);if(t>=r)return void c.warn(`å·²è¾¾åˆ°æœ€å¤§Workeræ•°é‡é™åˆ¶ (${r})ï¼Œä¸å†é‡å»ºWorker ${e}`);this.workers.delete(e),this.workerInfos.delete(e),await this.createWorker(),c.info(`Worker ${e} recreated (${this.workers.size}/${r})`)}catch(e){c.error(`Failed to recreate worker: ${e}`)}}addTaskToQueue(e){let t=this.taskQueue.length;for(let a=0;a<this.taskQueue.length;a++)if(this.taskQueue[a].priority<e.priority){t=a;break}this.taskQueue.splice(t,0,e),this.stats.queuedTasks=this.taskQueue.length}processQueue(){if(0===this.taskQueue.length)return;const e=this.findIdleWorker();if(!e)return void(this.workers.size<this.config.maxWorkers&&this.createWorker().then((()=>this.processQueue())));const t=this.taskQueue.shift();t&&(this.stats.queuedTasks=this.taskQueue.length,this.assignTaskToWorker(e,t))}findIdleWorker(){for(const[e,t]of this.workerInfos)if(t.status===p.IDLE)return e;return null}assignTaskToWorker(e,t){const a=this.workers.get(e),r=this.workerInfos.get(e);if(!a||!r)return;r.status=p.BUSY,r.currentTaskId=t.id,t.startedAt=Date.now(),this.activeTasks.set(t.id,t),this.stats.processingTasks=this.activeTasks.size;const s={id:this.generateMessageId(),type:t.type,payload:t.data,timestamp:Date.now()};this.sendMessage(e,s),this.emit("taskStarted",{taskId:t.id,workerId:e}),c.debug(`Task ${t.id} assigned to worker ${e}`)}async sendMessage(e,t){const a=this.workers.get(e);if(!a)throw new Error(`Worker ${e} not found`);a.postMessage(t)}async terminateWorker(e){return new Promise((t=>{const a=setTimeout((()=>{e.terminate(),t()}),5e3);e.once("exit",(()=>{clearTimeout(a),t()})),e.postMessage({id:this.generateMessageId(),type:f.TERMINATE,payload:{},timestamp:Date.now()})}))}startHeartbeat(){this.heartbeatInterval=setInterval((()=>{this.performHeartbeat()}),this.config.heartbeatInterval)}performHeartbeat(){const e=Date.now();for(const[t,a]of this.workerInfos){if(e-a.lastActiveAt>this.config.workerTimeout){c.warn(`Worker ${t} appears to be unresponsive`),this.recreateWorker(t);continue}const r=this.workers.get(t);r&&a.status===p.IDLE&&r.postMessage({id:this.generateMessageId(),type:f.PING,payload:{},timestamp:e})}}updateStats(){let e=0,t=0;for(const a of this.workerInfos.values())a.status===p.BUSY?e++:a.status===p.IDLE&&t++;this.stats.activeWorkers=e,this.stats.idleWorkers=t,this.stats.queuedTasks=this.taskQueue.length,this.stats.processingTasks=this.activeTasks.size,this.stats.systemLoad=e/Math.max(1,this.workers.size)*100}generateWorkerId(){return`worker_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateTaskId(){return`task_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateMessageId(){return`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}startResourceMonitoring(){this.resourceMonitorInterval=setInterval((()=>{this.performResourceCheck()}),3e4)}performResourceCheck(){const e=process.memoryUsage(),t=this.getStats();c.debug("Resource check",{memory:`${Math.round(e.heapUsed/1024/1024)}MB`,workers:`${t.activeWorkers}/${this.config.maxWorkers}`,queue:t.queuedTasks}),(t.activeWorkers>0||t.queuedTasks>0)&&this.logWorkerProcessingStatus(),e.heapUsed>52428800&&(c.warn("High memory usage detected, cleaning up idle workers"),this.cleanupIdleWorkers()),t.activeWorkers>this.config.maxWorkers&&(c.warn("Too many active workers, forcing cleanup"),this.forceCleanupWorkers())}cleanupIdleWorkers(){const e=Date.now();for(const[t,a]of this.workerInfos)if(a.status===p.IDLE&&e-a.lastActiveAt>6e4){c.info(`Cleaning up idle worker: ${t}`);const e=this.workers.get(t);e&&this.terminateWorker(e)}}forceCleanupWorkers(){const e=Array.from(this.workerInfos.keys()),t=e.length-this.config.maxWorkers;if(t>0){const a=e.map((e=>({id:e,info:this.workerInfos.get(e)}))).sort(((e,t)=>e.info.status===p.IDLE&&t.info.status!==p.IDLE?-1:t.info.status===p.IDLE&&e.info.status!==p.IDLE?1:e.info.createdAt-t.info.createdAt));for(let e=0;e<t&&e<a.length;e++){const t=a[e].id,r=this.workers.get(t);r&&(c.warn(`Force terminating worker: ${t}`),this.terminateWorker(r))}}}}const y=require("fs/promises");class k{constructor(e){this.patterns=[],e&&this.parseGitIgnore(e)}parseGitIgnore(e){this.patterns=e.split("\n").map((e=>e.trim())).filter((e=>e&&!e.startsWith("#"))).map((e=>(e.startsWith("/")&&(e=e.substring(1)),e.endsWith("/")&&(e+="**"),e)))}shouldIgnore(e){return this.patterns.some((t=>this.matchPattern(t,e)))}matchPattern(e,t){return e.includes("*")?new RegExp("^"+e.replace(/\*\*/g,".*").replace(/\*/g,"[^/]*").replace(/\?/g,"[^/]").replace(/\./g,"\\.")+"$").test(t):t.includes(e)}}class v{constructor(e){this.workspaceRoot=e||this.getWorkspaceRoot(),this.defaultOptions={includePatterns:["**/*.java","**/*.xml"],excludePatterns:["**/node_modules/**","**/target/**","**/build/**","**/out/**","**/bin/**","**/.git/**","**/.vscode/**","**/.idea/**"],maxFileSize:10485760,recursive:!0,includeTests:!1,parseContent:!0,maxDepth:10}}async scanWorkspace(e){const t=Date.now(),a={...this.defaultOptions,...e};c.info("å¼€å§‹æ‰«æå·¥ä½œç©ºé—´æ–‡ä»¶...");try{await this.initializeGitIgnore();const e={totalFiles:0,javaFileCount:0,xmlFileCount:0,entityCount:0,mapperCount:0,directoriesScanned:0,skippedFiles:0,errorFiles:0},r=[],s=[];await this.scanDirectory(this.workspaceRoot,a,r,s,e,0),a.parseContent&&await this.parseFileContents(r,s,e);const i=Date.now()-t;return c.info(`æ–‡ä»¶æ‰«æå®Œæˆ: ${e.totalFiles}ä¸ªæ–‡ä»¶, è€—æ—¶${i}ms`),{javaFiles:r,xmlFiles:s,stats:e,scanTime:i}}catch(e){throw c.error(`æ–‡ä»¶æ‰«æå¤±è´¥: ${e}`),e}}async initializeGitIgnore(){try{const e=await o.workspace.findFiles(".gitignore");if(e.length>0){const t=await o.workspace.fs.readFile(e[0]),a=Buffer.from(t).toString("utf8");this.gitIgnoreProcessor=new k(a),c.debug("å·²åŠ è½½.gitignoreæ–‡ä»¶")}else c.debug("æœªæ‰¾åˆ°.gitignoreæ–‡ä»¶")}catch(e){c.warn(`åŠ è½½.gitignoreæ–‡ä»¶å¤±è´¥: ${e}`)}}async scanDirectory(e,t,a,r,s,i){if(!(i>t.maxDepth))try{const n=await y.readdir(e,{withFileTypes:!0});s.directoriesScanned++;for(const o of n){const n=u.join(e,o.name),l=u.relative(this.workspaceRoot,n);this.gitIgnoreProcessor&&this.gitIgnoreProcessor.shouldIgnore(l)?(s.skippedFiles++,c.debug(`GitIgnoreè·³è¿‡: ${l}`)):this.shouldExclude(l,t.excludePatterns)?(s.skippedFiles++,c.debug(`æ’é™¤æ¨¡å¼è·³è¿‡: ${l}`)):o.isDirectory()?t.recursive&&await this.scanDirectory(n,t,a,r,s,i+1):o.isFile()&&await this.processFile(n,l,t,a,r,s)}}catch(t){c.warn(`æ‰«æç›®å½•å¤±è´¥ ${e}: ${t}`),s.errorFiles++}}async processFile(e,t,a,r,s,i){try{const n=u.basename(e),o=u.extname(n).toLowerCase();if(".java"!==o&&".xml"!==o)return;if(!a.includeTests&&this.isTestFile(t))return i.skippedFiles++,void c.debug(`æµ‹è¯•æ–‡ä»¶è·³è¿‡: ${t}`);const l=await y.stat(e);if(l.size>a.maxFileSize)return c.warn(`æ–‡ä»¶è¿‡å¤§ï¼Œè·³è¿‡: ${t} (${l.size} bytes)`),void i.skippedFiles++;const h={filePath:e,relativePath:t,fileName:n,size:l.size,lastModified:l.mtime.getTime(),fileType:".java"===o?"java":"xml"};".java"===o?(r.push(h),i.javaFileCount++,c.debug(`å‘ç°Javaæ–‡ä»¶: ${t}`)):".xml"===o&&(s.push(h),i.xmlFileCount++,c.debug(`å‘ç°XMLæ–‡ä»¶: ${t}`)),i.totalFiles++}catch(t){c.warn(`å¤„ç†æ–‡ä»¶å¤±è´¥ ${e}: ${t}`),i.errorFiles++}}async parseFileContents(e,t,a){c.info("å¼€å§‹è§£ææ–‡ä»¶å†…å®¹...");for(const t of e)try{await this.parseJavaFile(t),t.isEntity&&a.entityCount++}catch(e){c.warn(`è§£æJavaæ–‡ä»¶å¤±è´¥ ${t.relativePath}: ${e}`),a.errorFiles++}for(const e of t)try{await this.parseXmlFile(e),e.isMapper&&a.mapperCount++}catch(t){c.warn(`è§£æXMLæ–‡ä»¶å¤±è´¥ ${e.relativePath}: ${t}`),a.errorFiles++}}async parseJavaFile(e){try{const t=await y.readFile(e.filePath,"utf-8"),a=t.match(/package\s+([\w.]+)\s*;/);a&&(e.packageName=a[1]),e.isEntity=this.isEntityClass(t,e.fileName)}catch(e){throw new Error(`è¯»å–Javaæ–‡ä»¶å¤±è´¥: ${e}`)}}async parseXmlFile(e){try{const t=await y.readFile(e.filePath,"utf-8"),a=t.match(/namespace\s*=\s*["']([^"']+)["']/);a&&(e.namespace=a[1]),e.isMapper=this.isMapperFile(t,e.fileName)}catch(e){throw new Error(`è¯»å–XMLæ–‡ä»¶å¤±è´¥: ${e}`)}}isEntityClass(e,t){const a=["@Entity","@Table","@TableName","@Data","@Component"];for(const t of a)if(e.includes(t))return!0;const r=["@Id","@Column","@TableId","@TableField"];for(const t of r)if(e.includes(t))return!0;const s=/public\s+\w+\s+get\w+\s*\(/.test(e),i=/public\s+void\s+set\w+\s*\(/.test(e);if(s&&i)return!0;if(/private\s+\w+\s+\w+\s*;/.test(e))return!0;const n=[/Entity\.java$/i,/Model\.java$/i,/DO\.java$/i,/PO\.java$/i,/VO\.java$/i,/DTO\.java$/i,/Bean\.java$/i];for(const e of n)if(e.test(t))return!0;const o=e.match(/package\s+([\w.]+)\s*;/);if(o){const e=o[1].toLowerCase(),t=["entity","model","domain","pojo","bean","dto","vo","po"];for(const a of t)if(e.includes(a))return!0}if(e.includes("implements Serializable")||e.includes("extends Serializable"))return!0;const c=["javax.persistence","com.baomidou.mybatisplus","org.springframework.data.jpa","lombok.Data","lombok.Entity"];for(const t of c)if(e.includes(`import ${t}`))return!0;if((e.match(/private\s+\w+\s+\w+\s*;/g)||[]).length>=2){const t=e.match(/(?:public\s+)?class\s+(\w+)/);if(t){const e=t[1];if(![/Util$/i,/Utils$/i,/Helper$/i,/Config$/i,/Configuration$/i,/Constants?$/i,/Factory$/i,/Builder$/i,/Manager$/i,/Service$/i,/Controller$/i,/Repository$/i,/Dao$/i].some((t=>t.test(e))))return!0}}return!1}isMapperFile(e,t){if(t.toLowerCase().includes("mapper"))return!0;const a=["<mapper","<select","<insert","<update","<delete","<resultMap"];for(const t of a)if(e.includes(t))return!0;return!1}isTestFile(e){return[/\/test\//,/\/tests\//,/Test\.java$/,/Tests\.java$/,/TestCase\.java$/,/_test\.java$/,/_tests\.java$/].some((t=>t.test(e)))}shouldExclude(e,t){return t.some((t=>new RegExp(t.replace(/\*\*/g,".*").replace(/\*/g,"[^/]*").replace(/\?/g,"[^/]")).test(e)))}getWorkspaceRoot(){const e=o.workspace.workspaceFolders;if(!e||0===e.length)throw new Error("æ²¡æœ‰æ‰“å¼€çš„å·¥ä½œç©ºé—´");return e[0].uri.fsPath}createFileWatcher(e){const t=o.workspace.createFileSystemWatcher(new o.RelativePattern(this.workspaceRoot,"**/*.{java,xml}")),a=[t.onDidCreate((t=>e("created",t.fsPath))),t.onDidChange((t=>e("changed",t.fsPath))),t.onDidDelete((t=>e("deleted",t.fsPath))),t];return o.Disposable.from(...a)}async getFileContent(e){try{return await y.readFile(e,"utf-8")}catch(t){throw new Error(`è¯»å–æ–‡ä»¶å¤±è´¥ ${e}: ${t}`)}}async fileExists(e){try{return await y.access(e),!0}catch{return!1}}async getFileStats(e){return await y.stat(e)}async getFileContents(e){const t=new Map,a=e.map((async e=>{try{const a=await this.getFileContent(e);t.set(e,a)}catch(t){c.warn(`è¯»å–æ–‡ä»¶å¤±è´¥ ${e}: ${t}`)}}));return await Promise.all(a),t}filterFiles(e,t){return e.filter((e=>!(t.fileType&&e.fileType!==t.fileType||void 0!==t.isEntity&&e.isEntity!==t.isEntity||void 0!==t.isMapper&&e.isMapper!==t.isMapper||t.packageName&&e.packageName!==t.packageName||t.namespace&&e.namespace!==t.namespace||t.minSize&&e.size<t.minSize||t.maxSize&&e.size>t.maxSize||t.modifiedAfter&&e.lastModified<t.modifiedAfter)))}getGitIgnoreStatus(){return{loaded:!!this.gitIgnoreProcessor,patternCount:this.gitIgnoreProcessor?this.gitIgnoreProcessor.patterns.length:0}}}class E{generateERDiagram(e){const{entities:t,relations:a}=e;if(!t||0===t.length)return this.generateEmptyDiagram();let r="erDiagram\n";return r+=this.generateEntities(t),a&&a.length>0&&(r+="\n",r+=this.generateRelations(a)),r}generateEmptyDiagram(){return'erDiagram\n    NO_ENTITIES {\n        string message "æœªæ‰¾åˆ°MyBatiså®ä½“ç±»"\n        string suggestion "è¯·ç¡®ä¿é¡¹ç›®åŒ…å«@TableNameç­‰æ³¨è§£çš„å®ä½“ç±»"\n    }'}generateEntities(e){return e.map((e=>this.generateEntity(e))).join("\n\n")}generateEntity(e){let t=`    ${this.sanitizeTableName(e.tableName)} {\n`;e.fields&&e.fields.length>0?t+=e.fields.map((e=>this.generateField(e))).join("\n"):t+='        string placeholder "æš‚æ— å­—æ®µä¿¡æ¯"\n',t+="    }";const a=this.generateEntityComment(e);return a&&(t+=` %% ${a}`),t}generateField(e){return`        ${this.mapJavaTypeToDBType(e.javaType)} ${this.sanitizeColumnName(e.columnName)}${this.generateFieldConstraints(e)}`}generateFieldConstraints(e){const t=[];return e.isPrimaryKey&&t.push("PK"),e.isNotNull&&t.push("NOT NULL"),e.isUnique&&t.push("UNIQUE"),e.defaultValue&&t.push(`DEFAULT "${e.defaultValue}"`),e.comment&&t.push(`"${e.comment}"`),t.length>0?` ${t.join(" ")}`:""}generateEntityComment(e){const t=[];e.className&&t.push(`Javaç±»: ${e.className}`),e.comment&&t.push(e.comment);const a=e.annotations.find((e=>"TableName"===e.name||"Table"===e.name));return a&&t.push(`æ³¨è§£: @${a.name}`),t.join(", ")}generateRelations(e){return e.map((e=>this.generateRelation(e))).join("\n")}generateRelation(e){const t=this.sanitizeTableName(e.fromTable),a=this.sanitizeTableName(e.toTable);let r=`    ${t} ${this.getRelationshipSymbol(e.type)} ${a}`;(e.fromField||e.toField)&&(r+=` : ${this.generateRelationLabel(e)}`);const s=this.generateRelationComment(e);return s&&(r+=` %% ${s}`),r}getRelationshipSymbol(e){switch(e.toLowerCase()){case"one-to-one":default:return"||--||";case"one-to-many":return"||--o{";case"many-to-one":return"}o--||";case"many-to-many":return"}o--o{"}}generateRelationLabel(e){const t=[];return e.fromField&&t.push(e.fromField),e.toField&&e.toField!==e.fromField&&t.push(e.toField),t.join("-")}generateRelationComment(e){const t=[];return void 0!==e.confidence&&t.push(`ç½®ä¿¡åº¦: ${(100*e.confidence).toFixed(1)}%`),e.source&&t.push(`æ¥æº: ${e.source}`),e.description&&t.push(e.description),t.join(", ")}mapJavaTypeToDBType(e){return{String:"varchar",Integer:"int",int:"int",Long:"bigint",long:"bigint",Double:"double",double:"double",Float:"float",float:"float",Boolean:"boolean",boolean:"boolean",Date:"datetime",LocalDate:"date",LocalDateTime:"datetime",LocalTime:"time",Timestamp:"timestamp",BigDecimal:"decimal","byte[]":"blob","Byte[]":"blob"}[e.split("<")[0]]||"varchar"}sanitizeTableName(e){return e?e.replace(/[^a-zA-Z0-9_]/g,"_").toUpperCase():"UNKNOWN_TABLE"}sanitizeColumnName(e){return e?e.replace(/[^a-zA-Z0-9_]/g,"_").toLowerCase():"unknown_column"}generateThemedDiagram(e,t="default"){const a=this.generateERDiagram(e);return`%%{init: ${this.getThemeConfig(t)}}%%\n${a}`}getThemeConfig(e){const t={default:'{"theme": "default"}',dark:'{"theme": "dark"}',forest:'{"theme": "forest"}',neutral:'{"theme": "neutral"}'};return t[e]||t.default}generateStatistics(e){const{entities:t,relations:a}=e,r={entityCount:t.length,relationCount:a.length,fieldCount:t.reduce(((e,t)=>e+t.fields.length),0),relationTypes:{}};return a.forEach((e=>{const t=e.type;r.relationTypes[t]=(r.relationTypes[t]||0)+1})),r}validateMermaidCode(e){const t=[],a=[];e.trim().startsWith("erDiagram")||t.push('Mermaidä»£ç å¿…é¡»ä»¥"erDiagram"å¼€å¤´');const r=e.match(/\s+\w+\s*\{[^}]*\}/g);r&&0!==r.length||a.push("æœªæ‰¾åˆ°å®ä½“å®šä¹‰");const s=e.match(/\s+\w+\s+\|\|--[o\|]\{?\s+\w+/g);return s&&0!==s.length||a.push("æœªæ‰¾åˆ°å…³ç³»å®šä¹‰"),{isValid:0===t.length,errors:t,warnings:a}}}const T={entities:[{className:"User",tableName:"user",comment:"ç”¨æˆ·è¡¨",filePath:"/src/main/java/com/example/entity/User.java",annotations:[{name:"TableName",attributes:{value:"user"}}],fields:[{fieldName:"id",columnName:"id",javaType:"Long",isPrimaryKey:!0,isNotNull:!0,isUnique:!0,comment:"ç”¨æˆ·ID"},{fieldName:"username",columnName:"username",javaType:"String",isPrimaryKey:!1,isNotNull:!0,isUnique:!0,comment:"ç”¨æˆ·å"},{fieldName:"email",columnName:"email",javaType:"String",isPrimaryKey:!1,isNotNull:!0,isUnique:!0,comment:"é‚®ç®±"},{fieldName:"createTime",columnName:"create_time",javaType:"LocalDateTime",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"åˆ›å»ºæ—¶é—´"}]},{className:"Order",tableName:"order",comment:"è®¢å•è¡¨",filePath:"/src/main/java/com/example/entity/Order.java",annotations:[{name:"TableName",attributes:{value:"order"}}],fields:[{fieldName:"id",columnName:"id",javaType:"Long",isPrimaryKey:!0,isNotNull:!0,isUnique:!0,comment:"è®¢å•ID"},{fieldName:"userId",columnName:"user_id",javaType:"Long",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"ç”¨æˆ·ID"},{fieldName:"orderNo",columnName:"order_no",javaType:"String",isPrimaryKey:!1,isNotNull:!0,isUnique:!0,comment:"è®¢å•å·"},{fieldName:"totalAmount",columnName:"total_amount",javaType:"BigDecimal",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"æ€»é‡‘é¢"},{fieldName:"status",columnName:"status",javaType:"Integer",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"è®¢å•çŠ¶æ€"},{fieldName:"createTime",columnName:"create_time",javaType:"LocalDateTime",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"åˆ›å»ºæ—¶é—´"}]},{className:"OrderItem",tableName:"order_item",comment:"è®¢å•é¡¹è¡¨",filePath:"/src/main/java/com/example/entity/OrderItem.java",annotations:[{name:"TableName",attributes:{value:"order_item"}}],fields:[{fieldName:"id",columnName:"id",javaType:"Long",isPrimaryKey:!0,isNotNull:!0,isUnique:!0,comment:"è®¢å•é¡¹ID"},{fieldName:"orderId",columnName:"order_id",javaType:"Long",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"è®¢å•ID"},{fieldName:"productId",columnName:"product_id",javaType:"Long",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"äº§å“ID"},{fieldName:"quantity",columnName:"quantity",javaType:"Integer",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"æ•°é‡"},{fieldName:"price",columnName:"price",javaType:"BigDecimal",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"å•ä»·"}]},{className:"Product",tableName:"product",comment:"äº§å“è¡¨",filePath:"/src/main/java/com/example/entity/Product.java",annotations:[{name:"TableName",attributes:{value:"product"}}],fields:[{fieldName:"id",columnName:"id",javaType:"Long",isPrimaryKey:!0,isNotNull:!0,isUnique:!0,comment:"äº§å“ID"},{fieldName:"name",columnName:"name",javaType:"String",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"äº§å“åç§°"},{fieldName:"description",columnName:"description",javaType:"String",isPrimaryKey:!1,isNotNull:!1,isUnique:!1,comment:"äº§å“æè¿°"},{fieldName:"price",columnName:"price",javaType:"BigDecimal",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"ä»·æ ¼"},{fieldName:"stock",columnName:"stock",javaType:"Integer",isPrimaryKey:!1,isNotNull:!0,isUnique:!1,comment:"åº“å­˜"}]}],relations:[{fromTable:"user",toTable:"order",fromField:"id",toField:"user_id",type:"one-to-many",confidence:.95,source:"naming-convention",description:"ç”¨æˆ·ä¸è®¢å•çš„ä¸€å¯¹å¤šå…³ç³»"},{fromTable:"order",toTable:"order_item",fromField:"id",toField:"order_id",type:"one-to-many",confidence:.95,source:"naming-convention",description:"è®¢å•ä¸è®¢å•é¡¹çš„ä¸€å¯¹å¤šå…³ç³»"},{fromTable:"product",toTable:"order_item",fromField:"id",toField:"product_id",type:"one-to-many",confidence:.95,source:"naming-convention",description:"äº§å“ä¸è®¢å•é¡¹çš„ä¸€å¯¹å¤šå…³ç³»"}]};class b{constructor(){this.testResults=new Map}static getInstance(){return b.instance||(b.instance=new b),b.instance}startTest(e){const t=new S(e);return c.info(`å¼€å§‹æ€§èƒ½æµ‹è¯•: ${e}`),t}recordResult(e){this.testResults.set(e.testName,e),c.info(`æ€§èƒ½æµ‹è¯•å®Œæˆ: ${e.testName}`,{duration:e.duration,memoryUsed:e.memoryUsed,itemsProcessed:e.itemsProcessed})}getTestReport(){const e=Array.from(this.testResults.values());return{totalTests:e.length,results:e,summary:{totalDuration:e.reduce(((e,t)=>e+t.duration),0),averageDuration:e.length>0?e.reduce(((e,t)=>e+t.duration),0)/e.length:0,maxMemoryUsed:Math.max(...e.map((e=>e.memoryUsed))),totalItemsProcessed:e.reduce(((e,t)=>e+t.itemsProcessed),0)}}}async showPerformanceReport(){const e=this.getTestReport(),t=`\næ€§èƒ½æµ‹è¯•æŠ¥å‘Šï¼š\n\næ€»æµ‹è¯•æ•°: ${e.totalTests}\næ€»è€—æ—¶: ${e.summary.totalDuration.toFixed(2)}ms\nå¹³å‡è€—æ—¶: ${e.summary.averageDuration.toFixed(2)}ms\næœ€å¤§å†…å­˜ä½¿ç”¨: ${(e.summary.maxMemoryUsed/1024/1024).toFixed(2)}MB\næ€»å¤„ç†é¡¹ç›®: ${e.summary.totalItemsProcessed}\n\nè¯¦ç»†ç»“æœ:\n${e.results.map((e=>`- ${e.testName}: ${e.duration.toFixed(2)}ms, ${(e.memoryUsed/1024/1024).toFixed(2)}MB, ${e.itemsProcessed}é¡¹`)).join("\n")}\n        `.trim();await o.window.showInformationMessage(t,{modal:!0})}clearResults(){this.testResults.clear(),c.info("æ€§èƒ½æµ‹è¯•ç»“æœå·²æ¸…é™¤")}async runBenchmarkSuite(){c.info("å¼€å§‹è¿è¡ŒåŸºå‡†æµ‹è¯•å¥—ä»¶"),this.clearResults();const e=this.startTest("å†…å­˜ä½¿ç”¨åŸºå‡†");await this.simulateMemoryUsage(),e.finish(100);const t=this.startTest("è§£æé€Ÿåº¦åŸºå‡†");await this.simulateParsingLoad(),t.finish(500);const a=this.startTest("å…³ç³»æ¨æ–­åŸºå‡†");await this.simulateInferenceLoad(),a.finish(200);const r=this.getTestReport();return c.info("åŸºå‡†æµ‹è¯•å¥—ä»¶å®Œæˆ",r.summary),r}async simulateMemoryUsage(){const e=[];for(let t=0;t<1e4;t++)e.push({id:t,name:`Entity_${t}`,fields:Array.from({length:10},((e,a)=>({name:`field_${a}`,type:"String",value:`value_${t}_${a}`})))});await new Promise((e=>setTimeout(e,100))),e.length=0}async simulateParsingLoad(){for(let e=0;e<500;e++)Array.from({length:10},((e,t)=>`@Column(name = "field_${t}") private String field${t};`)).join("\n"),await new Promise((e=>setTimeout(e,1)))}async simulateInferenceLoad(){for(let e=0;e<200;e++){const t=Array.from({length:50},((t,a)=>({name:`Entity${a}`,fields:["id","name",`entity${e}_id`]})));for(const e of t)for(const t of e.fields)t.endsWith("_id")&&Math.random();await new Promise((e=>setTimeout(e,1)))}}}class S{constructor(e){this.testName=e,this.startTime=performance.now(),this.startMemory=this.getMemoryUsage()}finish(e=0){const t=performance.now(),a=this.getMemoryUsage(),r={testName:this.testName,duration:t-this.startTime,memoryUsed:a-this.startMemory,itemsProcessed:e,timestamp:new Date};return b.getInstance().recordResult(r),r}getMemoryUsage(){return process.memoryUsage?process.memoryUsage().heapUsed:0}}class C{constructor(e,t,a){this.isProcessing=!1,this.stateManager=e,this.configManager=t,this.webviewProvider=a,this.workerManager=new w,this.fileScanner=new v,this.mermaidGenerator=new E}async initialize(){try{const e=this.configManager.getExtensionConfig().execution;e.useWorkerThreads&&!e.useMainThreadSerial?(c.info("é…ç½®ä¸ºWorkerçº¿ç¨‹æ¨¡å¼ï¼Œå¯åŠ¨Workerç®¡ç†å™¨"),await this.workerManager.start(),c.info("Workerç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")):(c.info("é…ç½®ä¸ºä¸»çº¿ç¨‹ä¸²è¡Œæ¨¡å¼ï¼Œè·³è¿‡Workerç®¡ç†å™¨å¯åŠ¨"),c.info("Workerç®¡ç†å™¨å°†åœ¨éœ€è¦æ—¶å»¶è¿Ÿåˆå§‹åŒ–"))}catch(e){throw c.error("Workerç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥",e),e}}async ensureWorkerManagerStarted(){const e=this.configManager.getExtensionConfig().execution;if(e.useWorkerThreads&&!e.useMainThreadSerial){const e=this.workerManager.getStats();0===e.activeWorkers&&0===e.idleWorkers&&(c.info("å»¶è¿Ÿå¯åŠ¨Workerç®¡ç†å™¨"),await this.workerManager.start(),c.info("Workerç®¡ç†å™¨å»¶è¿Ÿåˆå§‹åŒ–å®Œæˆ"))}}async dispose(){try{const e=this.workerManager.getStats();e.activeWorkers>0||e.idleWorkers>0?(await this.workerManager.shutdown(),c.info("Workerç®¡ç†å™¨å·²å…³é—­")):c.info("Workerç®¡ç†å™¨æœªå¯åŠ¨ï¼Œè·³è¿‡å…³é—­æ“ä½œ")}catch(e){c.error("Workerç®¡ç†å™¨å…³é—­å¤±è´¥",e)}}async handleGenerateERDiagram(){if(o.workspace.workspaceFolders)try{if(!await this.stateManager.isMyBatisProject()&&"ç»§ç»­"!==await o.window.showWarningMessage("å½“å‰å·¥ä½œç©ºé—´ä¼¼ä¹ä¸æ˜¯MyBatisé¡¹ç›®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ","ç»§ç»­","å–æ¶ˆ"))return;const e=this.configManager.getExtensionConfig();if(c.info("å¼€å§‹ç”ŸæˆERå›¾",{workspace:this.stateManager.getCurrentWorkspacePath(),config:this.configManager.getConfigSummary()}),e.autoRefresh&&this.stateManager.isCacheValid()&&"ä½¿ç”¨ç¼“å­˜"===await o.window.showInformationMessage("å‘ç°æœ‰æ•ˆç¼“å­˜ï¼Œæ˜¯å¦ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Ÿ","ä½¿ç”¨ç¼“å­˜","é‡æ–°ç”Ÿæˆ")&&await this.stateManager.getERDiagramData())return c.info("ä½¿ç”¨ç¼“å­˜æ•°æ®ç”ŸæˆERå›¾"),void o.window.showInformationMessage("ERå›¾ç”Ÿæˆå®Œæˆï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰ï¼");await o.window.withProgress({location:o.ProgressLocation.Notification,title:"æ­£åœ¨ç”ŸæˆERå›¾...",cancellable:!0},(async(e,t)=>{await this.performERGeneration(e,t)})),c.info("ERå›¾ç”Ÿæˆå®Œæˆ"),o.window.showInformationMessage("ERå›¾ç”Ÿæˆå®Œæˆï¼")}catch(e){c.error("ç”ŸæˆERå›¾å¤±è´¥",e),o.window.showErrorMessage(`ç”ŸæˆERå›¾å¤±è´¥: ${e}`)}else o.window.showWarningMessage("è¯·å…ˆæ‰“å¼€ä¸€ä¸ªå·¥ä½œç©ºé—´")}async performERGeneration(e,t){e.report({increment:0,message:"æ‰«æé¡¹ç›®æ–‡ä»¶..."}),await this.stateManager.cleanExpiredCache();const a=await this.fileScanner.scanWorkspace({includeTests:this.configManager.getExtensionConfig().includeTestFiles});if(c.info(`æ–‡ä»¶æ‰«æå®Œæˆ: ${a.stats.totalFiles}ä¸ªæ–‡ä»¶`),e.report({increment:20,message:`å‘ç°${a.stats.entityCount}ä¸ªå®ä½“ç±»...`}),t.isCancellationRequested)throw new Error("ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ");const r=await this.batchProcessJavaFiles(a.javaFiles.filter((e=>e.isEntity)),e,t,20,25);e.report({increment:25,message:"è§£æXMLæ˜ å°„æ–‡ä»¶..."});const s=await this.batchProcessXmlFiles(a.xmlFiles.filter((e=>e.isMapper)),e,t,25,25);if(e.report({increment:25,message:"æ¨æ–­å®ä½“å…³ç³»..."}),t.isCancellationRequested)throw new Error("ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ");const i=await this.performRelationInference(r,s,t);if(e.report({increment:20,message:"ç”ŸæˆERå›¾..."}),t.isCancellationRequested)throw new Error("ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ");const n=await this.generateERDiagramData(r,s,i),o={entities:n.entities,relations:n.relations,mermaidCode:n.mermaidCode,metadata:n.metadata,generatedAt:new Date,projectPath:this.stateManager.getCurrentWorkspacePath()||""};await this.stateManager.saveERDiagramData(o),this.webviewProvider.updateDiagram(o),e.report({increment:10,message:"å®Œæˆ"}),c.info("ERå›¾ç”Ÿæˆå®Œæˆ",{entityCount:n.entities.length,relationCount:n.relations.length,scanStats:a.stats})}async batchProcessJavaFiles(e,t,a,r,s){if(0===e.length)return[];const i=this.configManager.getExtensionConfig().execution;return i.useWorkerThreads&&!i.useMainThreadSerial?(c.info("ä½¿ç”¨Workerçº¿ç¨‹æ¨¡å¼å¤„ç†Javaæ–‡ä»¶"),this.batchProcessJavaFilesWorker(e,t,a,r,s)):(c.info("ä½¿ç”¨ä¸»çº¿ç¨‹ä¸²è¡Œæ¨¡å¼å¤„ç†Javaæ–‡ä»¶ï¼ˆæ¨èï¼‰"),this.batchProcessJavaFilesSerial(e,t,a,r,s))}async batchProcessJavaFilesWorker(e,t,a,r,s){await this.ensureWorkerManagerStarted();const i=[],n=this.configManager.getExtensionConfig(),o=Math.min(n.execution.batchSize,Math.max(1,Math.floor(e.length/4))),l=this.chunkArray(e,o);c.info(`Workeræ¨¡å¼æ‰¹é‡å¤„ç†Javaæ–‡ä»¶: ${e.length}ä¸ªæ–‡ä»¶ï¼Œ${l.length}ä¸ªæ‰¹æ¬¡`);for(let e=0;e<l.length;e++){if(a.isCancellationRequested)throw new Error("ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ");const o=l[e],h=r+e*s/l.length;t.report({increment:h,message:`Workerå¤„ç†Javaæ–‡ä»¶æ‰¹æ¬¡ ${e+1}/${l.length} (${o.length}ä¸ªæ–‡ä»¶)`});try{const t=await Promise.all(o.map((async e=>({filePath:e.filePath,content:await this.fileScanner.getFileContent(e.filePath),fileType:"java",options:{parseMethodBodies:!1}})))),a=await this.workerManager.submitTask(f.PARSE_BATCH_FILES,{files:t},{timeout:n.execution.timeout,maxRetries:1});Array.isArray(a)?i.push(...a):i.push(a),c.debug(`Workeræ‰¹æ¬¡ ${e+1} å¤„ç†å®Œæˆï¼Œè§£æäº† ${o.length} ä¸ªæ–‡ä»¶`)}catch(e){c.warn("Workeræ‰¹é‡å¤„ç†Javaæ–‡ä»¶å¤±è´¥ï¼Œå°è¯•é™çº§å¤„ç†",e);for(const e of o)try{const t=await this.fileScanner.getFileContent(e.filePath),a=await this.parseJavaFileSync({filePath:e.filePath,content:t,fileType:"java",options:{parseMethodBodies:!1}});i.push(a)}catch(t){c.warn(`åŒæ­¥è§£æå¤±è´¥: ${e.filePath}`,t)}}e<l.length-1&&await new Promise((e=>setTimeout(e,100)))}return i}async batchProcessJavaFilesSerial(e,t,a,r,s){const i=[];this.configManager.getExtensionConfig(),c.info(`ä¸»çº¿ç¨‹ä¸²è¡Œå¤„ç†Javaæ–‡ä»¶: ${e.length}ä¸ªæ–‡ä»¶`);for(let n=0;n<e.length;n++){if(a.isCancellationRequested)throw new Error("ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ");const o=e[n],l=r+n*s/e.length;t.report({increment:l,message:`ä¸»çº¿ç¨‹è§£æJavaæ–‡ä»¶ ${n+1}/${e.length}: ${o.filePath.split("/").pop()}`});try{const e=await this.fileScanner.getFileContent(o.filePath),t=await this.parseJavaFileSync({filePath:o.filePath,content:e,fileType:"java",options:{parseMethodBodies:!1}});i.push(t),c.debug(`ä¸»çº¿ç¨‹è§£æå®Œæˆ: ${o.filePath}`)}catch(e){c.warn(`ä¸»çº¿ç¨‹è§£æJavaæ–‡ä»¶å¤±è´¥: ${o.filePath}`,e)}n%5==0&&n>0&&await new Promise((e=>setTimeout(e,10)))}return i}async batchProcessXmlFiles(e,t,a,r,s){if(0===e.length)return[];const i=this.configManager.getExtensionConfig().execution;return i.useWorkerThreads&&!i.useMainThreadSerial?(c.info("ä½¿ç”¨Workerçº¿ç¨‹æ¨¡å¼å¤„ç†XMLæ–‡ä»¶"),this.batchProcessXmlFilesWorker(e,t,a,r,s)):(c.info("ä½¿ç”¨ä¸»çº¿ç¨‹ä¸²è¡Œæ¨¡å¼å¤„ç†XMLæ–‡ä»¶ï¼ˆæ¨èï¼‰"),this.batchProcessXmlFilesSerial(e,t,a,r,s))}async batchProcessXmlFilesWorker(e,t,a,r,s){await this.ensureWorkerManagerStarted();const i=[],n=this.configManager.getExtensionConfig(),o=Math.min(n.execution.batchSize,Math.max(1,Math.floor(e.length/3))),l=this.chunkArray(e,o);c.info(`Workeræ¨¡å¼æ‰¹é‡å¤„ç†XMLæ–‡ä»¶: ${e.length}ä¸ªæ–‡ä»¶ï¼Œ${l.length}ä¸ªæ‰¹æ¬¡`);for(let e=0;e<l.length;e++){if(a.isCancellationRequested)throw new Error("ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ");const o=l[e],h=r+e*s/l.length;t.report({increment:h,message:`Workerå¤„ç†XMLæ–‡ä»¶æ‰¹æ¬¡ ${e+1}/${l.length} (${o.length}ä¸ªæ–‡ä»¶)`});try{const t=await Promise.all(o.map((async e=>({filePath:e.filePath,content:await this.fileScanner.getFileContent(e.filePath),fileType:"xml"})))),a=await this.workerManager.submitTask(f.PARSE_BATCH_FILES,{files:t},{timeout:n.execution.timeout,maxRetries:1});Array.isArray(a)?i.push(...a):i.push(a),c.debug(`Worker XMLæ‰¹æ¬¡ ${e+1} å¤„ç†å®Œæˆï¼Œè§£æäº† ${o.length} ä¸ªæ–‡ä»¶`)}catch(e){c.warn("Workeræ‰¹é‡å¤„ç†XMLæ–‡ä»¶å¤±è´¥ï¼Œå°è¯•é™çº§å¤„ç†",e);for(const e of o)try{const t=await this.fileScanner.getFileContent(e.filePath),a=await this.parseXmlFileSync({filePath:e.filePath,content:t,fileType:"xml"});i.push(a)}catch(t){c.warn(`åŒæ­¥è§£æXMLå¤±è´¥: ${e.filePath}`,t)}}e<l.length-1&&await new Promise((e=>setTimeout(e,80)))}return i}async batchProcessXmlFilesSerial(e,t,a,r,s){const i=[];this.configManager.getExtensionConfig(),c.info(`ä¸»çº¿ç¨‹ä¸²è¡Œå¤„ç†XMLæ–‡ä»¶: ${e.length}ä¸ªæ–‡ä»¶`);for(let n=0;n<e.length;n++){if(a.isCancellationRequested)throw new Error("ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ");const o=e[n],l=r+n*s/e.length;t.report({increment:l,message:`ä¸»çº¿ç¨‹è§£æXMLæ–‡ä»¶ ${n+1}/${e.length}: ${o.filePath.split("/").pop()}`});try{const e=await this.fileScanner.getFileContent(o.filePath),t=await this.parseXmlFileSync({filePath:o.filePath,content:e,fileType:"xml"});i.push(t),c.debug(`ä¸»çº¿ç¨‹XMLè§£æå®Œæˆ: ${o.filePath}`)}catch(e){c.warn(`ä¸»çº¿ç¨‹è§£æXMLæ–‡ä»¶å¤±è´¥: ${o.filePath}`,e)}n%3==0&&n>0&&await new Promise((e=>setTimeout(e,10)))}return i}async performRelationInference(e,t,a){if(a.isCancellationRequested)throw new Error("ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ");try{const a=this.configManager.getExtensionConfig().execution;if(a.useWorkerThreads&&!a.useMainThreadSerial){await this.ensureWorkerManagerStarted();const a=this.configManager.getExtensionConfig().inferenceStrategies,r=[{name:"naming-convention",weight:.8,enabled:a.naming,minConfidence:.6},{name:"annotation-based",weight:.9,enabled:a.annotation,minConfidence:.7},{name:"xml-mapping",weight:.85,enabled:a.xml,minConfidence:.75},{name:"field-type-analysis",weight:.7,enabled:a.semantic,minConfidence:.5}];return await this.workerManager.submitTask(f.INFER_RELATIONS,{entities:e.filter((e=>e&&!1!==e.success)),mappings:t.filter((e=>e&&!1!==e.success)),strategies:r},{timeout:15e3,maxRetries:1})}return c.info("ä½¿ç”¨ä¸»çº¿ç¨‹æ¨¡å¼è¿›è¡Œå…³ç³»æ¨æ–­"),this.performRelationInferenceSync(e,t)}catch(a){return c.warn("Workerå…³ç³»æ¨æ–­å¤±è´¥ï¼Œå°è¯•åŒæ­¥æ¨æ–­",a),this.performRelationInferenceSync(e,t)}}async generateERDiagramData(e,t,a){const r=e.filter((e=>e&&!1!==e.success)),s=(t.filter((e=>e&&!1!==e.success)),a?.relations||[]);return{entities:r,relations:s,mermaidCode:this.mermaidGenerator.generateERDiagram({entities:r,relations:s,generatedAt:new Date,projectPath:this.stateManager.getCurrentWorkspacePath()||""}),metadata:{generatedAt:(new Date).toISOString(),totalEntities:r.length,totalRelations:s.length,confidence:a?.confidence||0,processingStats:{javaFiles:e.length,xmlFiles:t.length,workerStats:this.workerManager.getStats()}}}}async parseJavaFileSync(e){try{const{SmartJavaParser:t}=await i.e(531).then(i.bind(i,531)),a=new t,r=await a.parseJavaFile(e.filePath,e.content);return r?(c.debug(`ä¸»çº¿ç¨‹Javaè§£æå®Œæˆ: ${e.filePath}`,{parseMethod:r.parseMethod,confidence:r.confidence,className:r.className,fieldCount:r.fields?.length||0}),{...r,filePath:e.filePath,success:!0,executionMode:"main-thread"}):(c.debug(`ä¸»çº¿ç¨‹Javaè§£ææœªæ‰¾åˆ°å®ä½“: ${e.filePath}`),{filePath:e.filePath,success:!1,reason:"not-entity-class",executionMode:"main-thread"})}catch(t){return c.warn(`ä¸»çº¿ç¨‹Javaè§£æå¤±è´¥: ${e.filePath}`,t),{filePath:e.filePath,error:t.message,success:!1,executionMode:"main-thread"}}}async parseXmlFileSync(e){try{const{SmartXmlParser:t}=await i.e(536).then(i.bind(i,536)),a=new t;return await a.parseXmlFile(e.filePath,e.content)}catch(t){return c.warn(`åŒæ­¥XMLè§£æå¤±è´¥: ${e.filePath}`,t),{filePath:e.filePath,error:t.message,success:!1}}}async performRelationInferenceSync(e,t){try{const{RelationInferenceEngine:a}=await i.e(301).then(i.bind(i,301)),r=new a,s=e.filter((e=>e&&!1!==e.success)),n=t.filter((e=>e&&!1!==e.success)),o=this.configManager.getExtensionConfig().inferenceStrategies,c=[{name:"naming-convention",weight:.8,enabled:o.naming,minConfidence:.6},{name:"annotation-based",weight:.9,enabled:o.annotation,minConfidence:.7},{name:"xml-mapping",weight:.85,enabled:o.xml,minConfidence:.75},{name:"field-type-analysis",weight:.7,enabled:o.semantic,minConfidence:.5}];return await r.inferRelations(s,n,{strategies:c})}catch(e){return c.warn("åŒæ­¥å…³ç³»æ¨æ–­å¤±è´¥",e),{relations:[],confidence:0,error:e.message}}}chunkArray(e,t){const a=[];for(let r=0;r<e.length;r+=t)a.push(e.slice(r,r+t));return a}async handleRefreshERDiagram(){if(this.isProcessing)o.window.showWarningMessage("ERå›¾ç”Ÿæˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...");else try{await this.stateManager.clearERDiagramData(),await this.stateManager.cleanExpiredCache(),await this.handleGenerateERDiagram()}catch(e){c.error("åˆ·æ–°ERå›¾å¤±è´¥",e),o.window.showErrorMessage(`åˆ·æ–°ERå›¾å¤±è´¥: ${e}`)}}async handleShowStatus(){try{const e=this.workerManager.getStats(),t=this.workerManager.getHealthStatus(),a=this.stateManager.getStateStats(),r=this.configManager.getConfigSummary(),s=process.memoryUsage(),i={"ğŸ”§ WorkerçŠ¶æ€":{æ´»è·ƒWorker:`${e.activeWorkers}/${e.activeWorkers+e.idleWorkers}`,é˜Ÿåˆ—ä»»åŠ¡:e.queuedTasks,å¤„ç†ä¸­ä»»åŠ¡:e.processingTasks,å·²å®Œæˆä»»åŠ¡:e.totalProcessedTasks,å¹³å‡é˜Ÿåˆ—æ—¶é—´:`${e.averageQueueTime}ms`},"ğŸ’¾ å†…å­˜ä½¿ç”¨":{å †å†…å­˜:`${Math.round(s.heapUsed/1024/1024)}MB`,æ€»å†…å­˜:`${Math.round(s.heapTotal/1024/1024)}MB`,å¤–éƒ¨å†…å­˜:`${Math.round(s.external/1024/1024)}MB`},"ğŸ¥ å¥åº·çŠ¶æ€":{çŠ¶æ€:t.healthy?"âœ… å¥åº·":"âš ï¸ å¼‚å¸¸",é—®é¢˜:t.issues.length>0?t.issues.join(", "):"æ— ",å»ºè®®:t.recommendations.length>0?t.recommendations.join(", "):"æ— "},"ğŸ“Š ç¼“å­˜çŠ¶æ€":a,"âš™ï¸ é…ç½®":r},n=Object.entries(i).map((([e,t])=>`${e}\n${Object.entries(t).map((([e,t])=>`  ${e}: ${t}`)).join("\n")}`)).join("\n\n"),c=await o.window.showInformationMessage("MyBatis ER Generator çŠ¶æ€ä¿¡æ¯",{modal:!0,detail:n},"å¤åˆ¶åˆ°å‰ªè´´æ¿","æ¸…ç†ç¼“å­˜","é‡å¯Worker");"å¤åˆ¶åˆ°å‰ªè´´æ¿"===c?(await o.env.clipboard.writeText(n),o.window.showInformationMessage("çŠ¶æ€ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")):"æ¸…ç†ç¼“å­˜"===c?await this.handleClearCache():"é‡å¯Worker"===c&&await this.restartWorkerManager()}catch(e){c.error("è·å–çŠ¶æ€ä¿¡æ¯å¤±è´¥",e),o.window.showErrorMessage(`è·å–çŠ¶æ€ä¿¡æ¯å¤±è´¥: ${e}`)}}async restartWorkerManager(){try{o.window.showInformationMessage("æ­£åœ¨é‡å¯Workerç®¡ç†å™¨..."),await this.workerManager.shutdown();const e=this.getOptimizedWorkerConfig();this.workerManager=new w(e),await this.workerManager.start(),o.window.showInformationMessage("Workerç®¡ç†å™¨é‡å¯å®Œæˆ"),c.info("Workerç®¡ç†å™¨é‡å¯å®Œæˆ")}catch(e){c.error("é‡å¯Workerç®¡ç†å™¨å¤±è´¥",e),o.window.showErrorMessage(`é‡å¯Workerç®¡ç†å™¨å¤±è´¥: ${e}`)}}getOptimizedWorkerConfig(){const e=i(857).cpus().length;return{maxWorkers:Math.min(e,6),workerTimeout:1e4,maxQueueSize:30,heartbeatInterval:2e3,maxRetries:1,enableProfiling:!1}}async handleClearCache(){try{"ç¡®å®š"===await o.window.showWarningMessage("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ é™¤å·²è§£æçš„æ•°æ®ã€‚","ç¡®å®š","å–æ¶ˆ")&&(await this.stateManager.clearERDiagramData(),await this.stateManager.cleanExpiredCache(),this.workerManager.getStats().activeWorkers>0&&c.info("æ¸…ç†WorkerçŠ¶æ€"),o.window.showInformationMessage("ç¼“å­˜å·²æ¸…é™¤"),c.info("ç”¨æˆ·æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜"))}catch(e){c.error("æ¸…é™¤ç¼“å­˜å¤±è´¥",e),o.window.showErrorMessage(`æ¸…é™¤ç¼“å­˜å¤±è´¥: ${e}`)}}async handleTestWebView(){try{c.info("åŠ è½½æµ‹è¯•æ•°æ®åˆ°WebView"),this.mermaidGenerator.generateERDiagram(T),this.webviewProvider.updateDiagram(T),o.window.showInformationMessage("æµ‹è¯•æ•°æ®å·²åŠ è½½åˆ°ERå›¾è§†å›¾ï¼")}catch(e){c.error("åŠ è½½æµ‹è¯•æ•°æ®å¤±è´¥",e),o.window.showErrorMessage(`åŠ è½½æµ‹è¯•æ•°æ®å¤±è´¥: ${e}`)}}async handlePerformanceBenchmark(){try{c.info("å¼€å§‹è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•"),await o.window.withProgress({location:o.ProgressLocation.Notification,title:"æ­£åœ¨è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•...",cancellable:!1},(async e=>{e.report({increment:0,message:"åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ..."});const t=b.getInstance();e.report({increment:30,message:"è¿è¡ŒåŸºå‡†æµ‹è¯•å¥—ä»¶..."}),await t.runBenchmarkSuite(),e.report({increment:100,message:"æµ‹è¯•å®Œæˆ"}),await t.showPerformanceReport()})),c.info("æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ")}catch(e){c.error("æ€§èƒ½åŸºå‡†æµ‹è¯•å¤±è´¥",e),o.window.showErrorMessage(`æ€§èƒ½åŸºå‡†æµ‹è¯•å¤±è´¥: ${e}`)}}async handleSimpleTest(){try{c.info("å¼€å§‹ç®€å•åŠŸèƒ½æµ‹è¯•");const e=this.workerManager.getStats();c.info("WorkerçŠ¶æ€",e);const t=this.stateManager.getStateStats();c.info("çŠ¶æ€ç®¡ç†å™¨",t);const a=this.configManager.getConfigSummary();c.info("é…ç½®ç®¡ç†å™¨",a),o.window.showInformationMessage(`æ‰©å±•åŠŸèƒ½æµ‹è¯•å®Œæˆï¼\nWorkerçŠ¶æ€: ${e.activeWorkers+e.idleWorkers}ä¸ªWorker\né…ç½®çŠ¶æ€: æ­£å¸¸\nçŠ¶æ€ç®¡ç†: æ­£å¸¸`),c.info("ç®€å•åŠŸèƒ½æµ‹è¯•å®Œæˆ")}catch(e){c.error("ç®€å•åŠŸèƒ½æµ‹è¯•å¤±è´¥",e),o.window.showErrorMessage(`åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${e}`)}}}class M{constructor(e,t){this._extensionUri=e,this._context=t}resolveWebviewView(e,t,a){this._view=e,e.webview.options={enableScripts:!0,localResourceRoots:[this._extensionUri]},e.webview.html=this._getHtmlForWebview(e.webview),e.webview.onDidReceiveMessage((e=>{switch(e.type){case"exportDiagram":this._exportDiagram(e.format);break;case"refreshDiagram":this._refreshDiagram();break;case"searchEntities":this._searchEntities(e.query);break;case"filterRelations":this._filterRelations(e.filter)}}),void 0,this._context.subscriptions)}updateDiagram(e){this._data=e,this._view&&this._view.webview.postMessage({type:"updateDiagram",data:e})}showLoading(e="æ­£åœ¨ç”ŸæˆERå›¾..."){this._view&&this._view.webview.postMessage({type:"showLoading",message:e})}showError(e){this._view&&this._view.webview.postMessage({type:"showError",error:e})}async _exportDiagram(e){if(this._data)try{const t=await o.window.showSaveDialog({defaultUri:o.Uri.file(`er-diagram.${e}`),filters:{[e.toUpperCase()]:[e]}});t&&this._view?.webview.postMessage({type:"exportToFile",format:e,path:t.fsPath})}catch(e){o.window.showErrorMessage(`å¯¼å‡ºå¤±è´¥: ${e}`)}else o.window.showWarningMessage("æ²¡æœ‰å¯å¯¼å‡ºçš„ERå›¾æ•°æ®")}async _refreshDiagram(){try{this.showLoading("æ­£åœ¨åˆ·æ–°ERå›¾..."),await o.commands.executeCommand("mybatis-er.generate")}catch(e){this.showError(`åˆ·æ–°å¤±è´¥: ${e}`)}}_searchEntities(e){this._view&&this._view.webview.postMessage({type:"searchResults",query:e,results:this._performSearch(e)})}_filterRelations(e){this._view&&this._view.webview.postMessage({type:"filterResults",filter:e,data:this._applyFilter(e)})}_performSearch(e){if(!this._data||!e.trim())return[];const t=e.toLowerCase();return this._data.entities.filter((e=>e.tableName.toLowerCase().includes(t)||e.className.toLowerCase().includes(t)||e.fields.some((e=>e.fieldName.toLowerCase().includes(t)||e.columnName.toLowerCase().includes(t)))))}_applyFilter(e){if(!this._data)return{entities:[],relations:[]};let t=this._data.entities,a=this._data.relations;return e.entityType&&(t=t.filter((t=>t.annotations.some((t=>t.name===e.entityType))))),e.relationType&&(a=a.filter((t=>t.type===e.relationType))),{entities:t,relations:a}}_getHtmlForWebview(e){const t=e.asWebviewUri(o.Uri.joinPath(this._extensionUri,"media","main.js")),a=e.asWebviewUri(o.Uri.joinPath(this._extensionUri,"media","mermaid-loader.js")),r=e.asWebviewUri(o.Uri.joinPath(this._extensionUri,"media","reset.css")),s=e.asWebviewUri(o.Uri.joinPath(this._extensionUri,"media","vscode.css")),i=e.asWebviewUri(o.Uri.joinPath(this._extensionUri,"media","main.css")),n=function(){let e="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let a=0;a<32;a++)e+=t.charAt(Math.floor(62*Math.random()));return e}();return`<!DOCTYPE html>\n            <html lang="zh-CN">\n            <head>\n                <meta charset="UTF-8">\n                <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${e.cspSource}; script-src 'nonce-${n}' 'unsafe-eval' https://cdn.jsdelivr.net; img-src ${e.cspSource} https:; connect-src https:;">\n                <meta name="viewport" content="width=device-width, initial-scale=1.0">\n                \n                <link href="${r}" rel="stylesheet">\n                <link href="${s}" rel="stylesheet">\n                <link href="${i}" rel="stylesheet">\n                \n                <title>MyBatis ER å›¾</title>\n            </head>\n            <body>\n                \x3c!-- å·¥å…·æ  --\x3e\n                <div class="toolbar">\n                    <div class="toolbar-group">\n                        <button id="refreshBtn" class="toolbar-btn" title="åˆ·æ–°ERå›¾">\n                            <span class="codicon codicon-refresh"></span>\n                            åˆ·æ–°\n                        </button>\n                        <button id="exportBtn" class="toolbar-btn" title="å¯¼å‡ºERå›¾">\n                            <span class="codicon codicon-export"></span>\n                            å¯¼å‡º\n                        </button>\n                    </div>\n                    \n                    <div class="toolbar-group">\n                        <input type="text" id="searchInput" placeholder="æœç´¢å®ä½“æˆ–å­—æ®µ..." class="search-input">\n                        <button id="searchBtn" class="toolbar-btn" title="æœç´¢">\n                            <span class="codicon codicon-search"></span>\n                        </button>\n                    </div>\n                    \n                    <div class="toolbar-group">\n                        <select id="filterSelect" class="filter-select">\n                            <option value="">å…¨éƒ¨å…³ç³»</option>\n                            <option value="one-to-one">ä¸€å¯¹ä¸€</option>\n                            <option value="one-to-many">ä¸€å¯¹å¤š</option>\n                            <option value="many-to-one">å¤šå¯¹ä¸€</option>\n                            <option value="many-to-many">å¤šå¯¹å¤š</option>\n                        </select>\n                    </div>\n                </div>\n                \n                \x3c!-- ä¸»è¦å†…å®¹åŒºåŸŸ --\x3e\n                <div class="main-content">\n                    \x3c!-- ä¾§è¾¹æ  --\x3e\n                    <div class="sidebar">\n                        <div class="sidebar-section">\n                            <h3>å®ä½“åˆ—è¡¨</h3>\n                            <div id="entityList" class="entity-list"></div>\n                        </div>\n                        \n                        <div class="sidebar-section">\n                            <h3>å…³ç³»ç»Ÿè®¡</h3>\n                            <div id="relationStats" class="relation-stats"></div>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- ERå›¾ç”»å¸ƒ --\x3e\n                    <div class="diagram-container">\n                        <div id="loadingIndicator" class="loading-indicator" style="display: none;">\n                            <div class="loading-spinner"></div>\n                            <div class="loading-text">æ­£åœ¨ç”ŸæˆERå›¾...</div>\n                        </div>\n                        \n                        <div id="errorIndicator" class="error-indicator" style="display: none;">\n                            <div class="error-icon">âš ï¸</div>\n                            <div class="error-text"></div>\n                        </div>\n                        \n                        <div id="diagramCanvas" class="diagram-canvas"></div>\n                    </div>\n                </div>\n                \n                \x3c!-- å¯¼å‡ºå¯¹è¯æ¡† --\x3e\n                <div id="exportModal" class="modal" style="display: none;">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h3>å¯¼å‡ºERå›¾</h3>\n                            <button id="closeModal" class="close-btn">&times;</button>\n                        </div>\n                        <div class="modal-body">\n                            <div class="export-options">\n                                <label>\n                                    <input type="radio" name="exportFormat" value="png" checked>\n                                    PNG å›¾ç‰‡\n                                </label>\n                                <label>\n                                    <input type="radio" name="exportFormat" value="svg">\n                                    SVG çŸ¢é‡å›¾\n                                </label>\n                                <label>\n                                    <input type="radio" name="exportFormat" value="pdf">\n                                    PDF æ–‡æ¡£\n                                </label>\n                            </div>\n                        </div>\n                        <div class="modal-footer">\n                            <button id="confirmExport" class="btn btn-primary">å¯¼å‡º</button>\n                            <button id="cancelExport" class="btn btn-secondary">å–æ¶ˆ</button>\n                        </div>\n                    </div>\n                </div>\n                \n                <script nonce="${n}" src="${a}"><\/script>\n                <script nonce="${n}" src="${t}"><\/script>\n            </body>\n            </html>`}}let R,P,$,x;async function I(e){c.initialize(),R=h.initialize(e),P=m.getInstance(),x=new M(e.extensionUri,e),e.subscriptions.push(o.window.registerWebviewViewProvider(M.viewType,x)),$=new C(R,P,x);try{await $.initialize(),c.info("Workerç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")}catch(e){return c.error("Workerç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥",e),void o.window.showErrorMessage(`Workerç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: ${e}`)}c.info("MyBatis ER Generator æ‰©å±•å·²æ¿€æ´»");const t=P.validateConfig();t.valid||(c.warn("é…ç½®éªŒè¯å¤±è´¥",t.errors),o.window.showWarningMessage(`é…ç½®å­˜åœ¨é—®é¢˜: ${t.errors.join(", ")}`));const a=o.commands.registerCommand("mybatis-er.generate",(()=>$.handleGenerateERDiagram())),r=o.commands.registerCommand("mybatis-er.refresh",(()=>$.handleRefreshERDiagram())),s=o.commands.registerCommand("mybatis-er.export",(()=>$.handleExportERDiagram())),n=o.commands.registerCommand("mybatis-er.settings",(()=>$.handleOpenSettings())),l=o.commands.registerCommand("mybatis-er.status",(()=>$.handleShowStatus())),d=o.commands.registerCommand("mybatis-er.clearCache",(()=>$.handleClearCache())),u=o.commands.registerCommand("mybatis-er.testWebView",(()=>$.handleTestWebView())),g=o.commands.registerCommand("mybatis-er.performanceBenchmark",(()=>$.handlePerformanceBenchmark())),f=o.commands.registerCommand("mybatis-er.simpleTest",(()=>$.handleSimpleTest())),p=o.commands.registerCommand("mybatis-er.javaExtensionDiagnostic",(async()=>{const{quickJavaExtensionDiagnostic:e}=await i.e(987).then(i.t.bind(i,987,23));return e()})),w=o.commands.registerCommand("mybatis-er.testWorkerThreadFix",(async()=>{const{testWorkerThreadFix:e}=await i.e(885).then(i.t.bind(i,885,23));return e()})),y=o.commands.registerCommand("mybatis-er.testVSCodeAPILoading",(async()=>{const{testVSCodeAPILoading:e}=await i.e(430).then(i.t.bind(i,430,23));return e()})),k=o.commands.registerCommand("mybatis-er.quickVSCodeTest",(async()=>{const{quickVSCodeTest:e,testJavaParserVSCodeAPI:t}=await i.e(104).then(i.t.bind(i,104,23));await e(),await t()})),v=P.onConfigChanged((e=>{c.info("é…ç½®å·²å˜æ›´ï¼Œé‡æ–°åº”ç”¨è®¾ç½®",e)})),E=o.workspace.onDidChangeWorkspaceFolders((async e=>{c.info("å·¥ä½œç©ºé—´å·²å˜æ›´",{added:e.added.length,removed:e.removed.length}),e.removed.length>0&&await R.resetWorkspaceState()}));e.subscriptions.push(a,r,s,n,l,d,u,g,f,p,w,y,k,v,E,{dispose:()=>$.dispose()});const T=P.getConfigSummary(),b=R.getStateStats();o.window.showInformationMessage("MyBatis ER Generator å·²å°±ç»ªï¼"),c.info("æ‰©å±•æ¿€æ´»å®Œæˆï¼Œæ‰€æœ‰å‘½ä»¤å·²æ³¨å†Œ",{config:T,state:b})}async function W(){c.info("MyBatis ER Generator æ‰©å±•æ­£åœ¨åœç”¨..."),$&&await $.dispose(),c.info("MyBatis ER Generator æ‰©å±•å·²åœç”¨"),c.dispose()}M.viewType="mybatis-er.erDiagramView",module.exports=n})();
//# sourceMappingURL=extension.js.map